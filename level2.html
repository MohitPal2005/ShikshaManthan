<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Level 2 ‚Äì Student Outcome | ShikshaManthan</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script src="assets/js/data.js"></script>
  <script src="assets/js/progress.js"></script>

  <style>
    body { font-family: 'Poppins', sans-serif; }

    /* Background Pattern */
    .bg-grid-pattern {
        background-image: radial-gradient(#6366f1 0.5px, transparent 0.5px);
        background-size: 24px 24px;
        opacity: 0.1;
    }

    /* AI Animations */
    @keyframes pulse-ring {
        0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
        100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
    }
    .ai-thinking { animation: pulse-ring 2s infinite; }
    
    /* Progress Bar Override */
    #progressBar, .progress-bar-fill { background-color: #4f46e5 !important; }
    .progress-step-active { background-color: #4f46e5 !important; border-color: #4f46e5 !important; color: white !important; }
  </style>
</head>

<body class="bg-slate-50 min-h-screen relative text-slate-800">

<div class="fixed inset-0 bg-grid-pattern pointer-events-none z-0"></div>

<div id="header" class="relative z-20 sticky top-0 bg-white/90 backdrop-blur shadow-sm"></div>

<main class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 mb-20 grid grid-cols-1 lg:grid-cols-3 gap-8">

  <section class="lg:col-span-2 bg-white rounded-2xl shadow-xl border border-slate-100 p-6 sm:p-8 relative overflow-hidden group flex flex-col justify-between">
    
    <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-indigo-500 via-purple-500 to-indigo-500"></div>

    <div>
      <div class="mb-6">
        <div class="flex items-center gap-3 mb-2">
          <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-bold uppercase tracking-wide">Level 2</span>
          <span class="text-slate-400 text-sm font-medium">Student-Impact</span>
        </div>
        
        <h1 id="aiQuestion" class="text-2xl sm:text-3xl font-bold text-slate-800 leading-tight transition-all duration-300">
          What change do we want to see at the student level?
        </h1>
        
        <p id="aiSubtext" class="text-slate-500 mt-2 text-sm sm:text-base transition-all duration-300">
          If this problem is addressed, what will student be able to do differently?
        </p>
      </div>

      <div class="relative">
        <textarea
          id="outcomeInput"
          rows="6"
          placeholder="Example: if student then will be able to read grade-level text fluently with understanding."
          class="w-full p-5 bg-slate-50 border-2 border-slate-200 rounded-xl text-slate-700 placeholder-slate-400 focus:bg-white focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all resize-none shadow-inner"
          oninput="handleAIFlow(this.value)"
        ></textarea>
        <div id="statusBadge" class="absolute bottom-4 right-4 text-xs font-medium text-slate-400 transition-colors">
          Waiting for input...
        </div>
      </div>

      <div class="mt-6 bg-indigo-50/50 border border-indigo-100 p-5 rounded-xl flex gap-4 items-start">
        <div class="text-2xl pt-1">üéØ</div>
        <div>
          <h4 class="font-semibold text-indigo-900 text-sm mb-2">Outcome Checklist</h4>
          <ul id="tipsList" class="space-y-1.5 text-sm text-slate-600">
            <li class="flex items-center gap-2"><span class="w-1.5 h-1.5 bg-indigo-400 rounded-full"></span> Focus on Permanent change in student's behaviour</li>
            <li class="flex items-center gap-2"><span class="w-1.5 h-1.5 bg-indigo-400 rounded-full"></span> Outcome should be observable</li>
            <li class="flex items-center gap-2"><span class="w-1.5 h-1.5 bg-indigo-400 rounded-full"></span> Avoid activities like training or workshops</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="mt-8 flex items-center justify-between border-t border-slate-100 pt-6">
      <button onclick="goBack()"
        class="flex items-center gap-2 px-5 py-2.5 rounded-full text-slate-500 hover:bg-slate-100 hover:text-slate-700 font-medium transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        Back
      </button>

      <div class="flex items-center gap-4">
        <button onclick="submitOutcome()" 
            style="border: 2px solid #4f46e5; background-color: white; color: #4f46e5; padding: 10px 24px; border-radius: 0.75rem; font-weight: 700; cursor: pointer; transition: all 0.3s ease;">
            Submit
        </button>

        <button id="continueBtn"
            disabled
            onclick="saveAndNext()"
            class="px-8 py-3 rounded-xl font-bold text-white shadow-lg transition-all transform active:scale-95 flex items-center gap-2 disabled:bg-slate-200 disabled:text-slate-400 disabled:shadow-none disabled:cursor-not-allowed bg-indigo-600 hover:bg-indigo-700 hover:shadow-indigo-500/30">
            Continue
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
      </div>
    </div>

  </section>

  <aside class="lg:col-span-1">
    
    <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6 relative overflow-hidden h-full flex flex-col justify-between">
        
        <div class="absolute -top-10 -left-10 w-32 h-32 bg-violet-100 rounded-full blur-2xl opacity-60 pointer-events-none"></div>

        <div class="text-center relative z-10">
            <div id="aiAvatarContainer" class="relative mx-auto w-20 h-20 mb-4 flex items-center justify-center">
                <div id="aiPulse" class="absolute inset-0 rounded-full border-2 border-indigo-100"></div>
                <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-violet-600 rounded-full flex items-center justify-center text-2xl shadow-lg text-white z-10 transition-transform duration-300" id="aiFace">
                    ü§ñ
                </div>
            </div>

            <h2 class="text-lg font-bold text-slate-800">AI Feedback</h2>
            <div class="h-1 w-10 bg-indigo-100 mx-auto rounded-full my-3"></div>
            
            <div id="aiFeedback" class="text-sm text-slate-500 italic min-h-[3rem] transition-colors duration-300 text-left">
            "I'm checking if the outcome is stakeholders-focused and measurable..."
            </div>
        </div>

        <div class="bg-slate-900 rounded-2xl shadow-lg p-6 text-white relative overflow-hidden mt-6">
            <div class="flex justify-between items-end mb-2">
                <span class="text-slate-400 text-xs font-semibold uppercase tracking-wider">Clarity Score</span>
                <span id="scoreText" class="text-2xl font-bold text-indigo-400">0%</span>
            </div>
            
            <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden">
                <div id="clarityBar" class="h-full bg-gradient-to-r from-indigo-400 to-violet-400 w-0 transition-all duration-500 ease-out"></div>
            </div>
            
            <div class="mt-4 flex gap-2 text-xs text-slate-400">
            <span>üìè</span>
            <span>Aim for >60% to continue</span>
            </div>
        </div>

    </div>

  </aside>

</main>

<script>
/* ================= INIT ================= */

fetch("components/header.html")
  .then(r => r.text())
  .then(h => {
    // Inject and fix theme colors in header (Teal -> Indigo)
    document.getElementById("header").innerHTML = h.replace(/teal/g, "indigo");

    loadData();

    // Guard Clause: Block if Level 1 incomplete
    if (!isLevel1Complete()) {
        // Uncomment in production:
        // window.location.href = "level1.html";
        // return;
    }

    // Set Header Progress (Level 2 start)
    if(typeof setProgress === 'function') setProgress(14);
  });

/* ================= GUARD ================= */

function isLevel1Complete() {
  // Ensure lfaData exists
  if(typeof lfaData === 'undefined') return false;
  return lfaData.problem && lfaData.problem.length > 20;
}

/* ================= AI STATE ================= */

let ai = {
  understanding: 0,   // 0‚Äì100
  stage: 1            // 1=vague, 2=measurable, 3=clear
};

/* ================= CORE AI FLOW ================= */
function handleAIFlow(text) {
  text = text.trim();
  lfaData.studentOutcome = text;
  
  // UI References
  const aiFace = document.getElementById("aiFace");
  const statusBadge = document.getElementById("statusBadge");

  // Reset Score Visuals to 0 while typing (User request)
  document.getElementById("clarityBar").style.width = "0%";
  document.getElementById("scoreText").innerText = "0%";

  // Default State
  statusBadge.innerText = "Listening...";
  statusBadge.className = "absolute bottom-4 right-4 text-xs font-medium text-slate-400";
  
  // 1. Text is too short (< 60 chars)
  if (text.length < 60) {
    ai.stage = 1;
    ai.understanding = 0; // Keep internal score 0

    updateUI(
      "What change do you want to see for students?",
      "Describe a clear student-level change",
      [
        "Think about what students will be able to do",
        "Minimum 60 characters required"
      ],
      "‚úèÔ∏è Keep typing... (Minimum 60 characters)"
    );

    // Ensure visual is neutral
    document.getElementById("aiFace").innerText = "ü§î";
    
    // Lock 'Continue' (Next Level) until they submit successfully
    lockContinue();
    return;
  }

  // 2. Activity Detected (Bad Practice Check)
  if (
    text.toLowerCase().includes("training") ||
    text.toLowerCase().includes("workshop") ||
    text.toLowerCase().includes("session")
  ) {
    updateUI(
      "Focus on student ability, not activities",
      "Avoid words like 'training' or 'workshop'",
      [
        "Outcome should describe student behaviour",
        "Don't describe what the teacher does"
      ],
      "üö´ This sounds like an activity, not a student outcome."
    );
    document.getElementById("aiFace").innerText = "üôÖ‚Äç‚ôÇÔ∏è";
    return;
  }

  // 3. Ready to Submit (>= 60 chars)
  // We do NOT generate a score here. We just say "Ready".
  updateUI(
    "Ready to Verify",
    "Click 'Submit' to get your Clarity Score",
    [
      "Outcomes must describe student-level change",
      "Outcome should be observable"
    ],
    "üëá Click 'Submit' to calculate score"
  );
  
  document.getElementById("aiFace").innerText = "üëç";
}

/* ================= UI UPDATES ================= */

function updateVisuals(score, emoji) {
    // Update Score Bar
    document.getElementById("clarityBar").style.width = score + "%";
    document.getElementById("scoreText").innerText = score + "%";
    
    // Update Avatar
    document.getElementById("aiFace").innerText = emoji;
    
    // Update Global Progress (Header)
    updateProgress();
}

function updateUI(title, sub, tips, feedback) {
  // Smooth Text Update
  const tEl = document.getElementById("aiQuestion");
  if(tEl.innerText !== title) {
      tEl.innerText = title;
      tEl.classList.add("animate-pulse");
      setTimeout(() => tEl.classList.remove("animate-pulse"), 500);
  }
  document.getElementById("aiSubtext").innerText = sub;

  // Update List
  const list = document.getElementById("tipsList");
  list.innerHTML = "";
  tips.forEach(t => {
    const li = document.createElement("li");
    li.className = "flex items-center gap-2";
    li.innerHTML = `<span class="w-1.5 h-1.5 bg-indigo-400 rounded-full"></span> ${t}`;
    list.appendChild(li);
  });

  // Update Feedback Text Color AND Maintain Left Alignment
  const fb = document.getElementById("aiFeedback");
  fb.innerText = feedback;
  if(feedback.includes("‚úÖ")) {
      fb.className = "text-sm font-semibold text-green-600 min-h-[3rem] transition-colors duration-300 text-left";
  } else if(feedback.includes("üö´")) {
      fb.className = "text-sm font-semibold text-red-500 min-h-[3rem] transition-colors duration-300 text-left";
  } else {
      fb.className = "text-sm italic text-slate-500 min-h-[3rem] transition-colors duration-300 text-left";
  }
}

/* ================= PROGRESS ================= */

function updateProgress() {
  const base = 14;   // completed till Level 1
  const range = 14; // contribution of Level 2

  const pct = base + Math.round((ai.understanding / 100) * range);
  if(typeof setProgress === 'function') setProgress(pct);
}

/* ================= BUTTON STATES ================= */

function unlockContinue() {
  const b = document.getElementById("continueBtn");
  b.disabled = false;
  b.classList.remove("bg-slate-200", "text-slate-400");
  b.classList.add("bg-indigo-600", "hover:bg-indigo-700", "text-white", "shadow-lg", "hover:-translate-y-1");
}

function lockContinue() {
  const b = document.getElementById("continueBtn");
  b.disabled = true;
  b.classList.add("bg-slate-200", "text-slate-400");
  b.classList.remove("bg-indigo-600", "hover:bg-indigo-700", "text-white", "shadow-lg", "hover:-translate-y-1");
}

/* ================= NAV ================= */

function saveAndNext() {
  // if (ai.understanding < 100) {
  //   alert("AI is still refining the student outcome.");
  //   return;
  // }

  saveData();
  window.location.href = "level3.html";
}
async function callOutcomeEvaluator(problem, outcome) {
  try {
    const res = await fetch("https://shivam-99x-shikshamanthan-backend.hf.space/evaluate-outcome", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        problem: problem,
        outcome: outcome
      })
    });

    const data = await res.json();
    return data.evaluation;
  } catch (err) {
    return "‚ö†Ô∏è Unable to evaluate outcome at this time.";
  }
}
async function submitOutcome() {
  const problem = lfaData.problem;
  const outcome = document.getElementById("outcomeInput").value.trim();

  // --- VALIDATION START ---
  
  // 1. Check Level 1 completion
  if (!problem || problem.length < 20) {
    alert("Teacher problem is missing. Please complete Level 1.");
    return;
  }

  // 2. NEW RULE: Check for 60 characters
  if (outcome.length < 60) {
    alert("Please write at least 60 characters."); // The Popup
    return;
  }

  // --- VALIDATION END ---

  // UI Setup: Show loading
  const submitBtn = document.querySelector("button[onclick='submitOutcome()']");
  const aiFeedback = document.getElementById("aiFeedback");
  
  aiFeedback.innerText = "ü§ñ Calculating Clarity Score...";
  // ADDED text-left
  aiFeedback.className = "text-sm font-semibold text-indigo-600 animate-pulse text-left";
  
  submitBtn.disabled = true; 
  submitBtn.innerText = "Calculating...";

  try {
    // 1. CALL BACKEND
    const res = await fetch("https://shivam-99x-shikshamanthan-backend.hf.space/evaluate-outcome", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        problem: problem,
        outcome: outcome
      })
    });

    const data = await res.json();

    // 2. Update Feedback Text
    aiFeedback.innerText = data.evaluation;
    
    // Style the feedback text based on content AND Maintain Left Alignment
    if(data.evaluation.includes("‚úÖ")) aiFeedback.className = "text-sm font-semibold text-green-600 text-left";
    else if(data.evaluation.includes("üö´")) aiFeedback.className = "text-sm font-semibold text-red-500 text-left";
    else aiFeedback.className = "text-sm text-slate-600 text-left";

    // 3. PARSE & SHOW CLARITY SCORE (Only happens here)
    const match = data.evaluation.match(/(\d+)%/);
    if (match) {
      const score = parseInt(match[1]);
      
      // Update the Global Variable
      ai.understanding = score; 
      
      // Update the UI Bar (This is the moment the score appears)
      document.getElementById("clarityBar").style.width = score + "%";
      document.getElementById("scoreText").innerText = score + "%";
      document.getElementById("aiFace").innerText = score > 70 ? "ü§©" : "üßê";
      
      // 4. Unlock 'Continue' only if score is high enough
      if (score > 60) {
          unlockContinue();
      } else {
          lockContinue();
          // Optional: alert("Score is too low. Please refine.");
      }
    }

  } catch (err) {
    aiFeedback.innerText = "‚ùå Connection Error. Please try again.";
    // ADDED text-left
    aiFeedback.className = "text-sm font-bold text-red-600 text-left";
    console.error(err);
  } finally {
    // Reset Button
    submitBtn.disabled = false;
    submitBtn.innerText = "Submit";
  }
}


function goBack() {
  window.location.href = "level1.html";
}
</script>

</body>
</html>
