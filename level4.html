<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Level 4 â€“ Stakeholder Mapping | ShikshaManthan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="assets/js/data.js"></script>
  <script src="assets/js/progress.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }

    /* Background Pattern */
    .bg-grid-pattern {
      background-image: radial-gradient(#6366f1 0.5px, transparent 0.5px);
      background-size: 24px 24px;
      opacity: 0.1;
    }

    /* AI Animations */
    @keyframes pulse-ring {
      0% {
        transform: scale(0.8);
        box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7);
      }

      70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(99, 102, 241, 0);
      }

      100% {
        transform: scale(0.8);
        box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
      }
    }

    .ai-thinking {
      animation: pulse-ring 2s infinite;
    }

    /* Thinking Dots */
    .thinking-dots span {
      animation: bounce 1.4s infinite ease-in-out both;
      background-color: #6366f1;
      border-radius: 50%;
      display: inline-block;
      height: 6px;
      width: 6px;
      margin: 0 2px;
    }

    .thinking-dots span:nth-child(1) {
      animation-delay: -0.32s;
    }

    .thinking-dots span:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes bounce {

      0%,
      80%,
      100% {
        transform: scale(0);
      }

      40% {
        transform: scale(1);
      }
    }

    /* Typewriter Cursor */
    .cursor::after {
      content: '|';
      animation: blink 1s step-start infinite;
      color: #6366f1;
    }

    @keyframes blink {
      50% {
        opacity: 0;
      }
    }

    /* Layout Transition: Smoothly resize columns */
    #mainGrid {
      transition: grid-template-columns 0.8s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    /* AI Markdown Styles - Specific Overrides */
    .ai-markdown strong {
      color: #4338ca;
      /* Indigo-800 */
      font-weight: 700;
    }

    .ai-markdown ul {
      list-style-type: disc;
      padding-left: 1.5rem;
      margin-top: 8px;
      margin-bottom: 12px;
    }

    .ai-markdown li {
      margin-bottom: 6px;
      color: #334155;
    }

    .ai-markdown h3 {
      font-weight: 700;
      color: #1e293b;
      margin-top: 16px;
      margin-bottom: 8px;
      font-size: 1rem;
      border-bottom: 1px solid #e0e7ff;
      padding-bottom: 4px;
    }
  </style>
</head>

<body class="bg-slate-50 min-h-screen relative text-slate-800 overflow-x-hidden">
  <div class="fixed inset-0 bg-grid-pattern pointer-events-none z-0"></div>
  <div id="header" class="relative z-20 sticky top-0 bg-white/90 backdrop-blur shadow-sm"></div>
  <main id="mainGrid"
    class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 mb-20 grid grid-cols-1 lg:grid-cols-[2fr_1fr] gap-8">
    <section id="leftPanel"
      class="bg-white rounded-2xl shadow-xl border border-slate-100 p-6 sm:p-8 relative overflow-hidden flex flex-col h-full transition-all duration-500">
      <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-indigo-500 via-violet-500 to-indigo-500">
      </div>
      <div class="mb-6">
        <div class="flex items-center gap-3 mb-2"> <span
            class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-bold uppercase tracking-wide">Level
            4</span> <span class="text-slate-400 text-sm font-medium">System Actors</span> </div>
        <h1 class="text-2xl sm:text-3xl font-bold text-slate-800 leading-tight"> Who needs to take action to address
          your problem? </h1>
        <p class="text-slate-500 mt-2 text-sm sm:text-base"> Drag stakeholders into the Esosystem map. Big Changes
          requires proper actions at multiple levels. </p>
        <div class="mt-3 bg-indigo-50 border-l-4 border-indigo-400 px-4 py-2 rounded-r-lg">
          <p class="text-xs sm:text-sm text-indigo-700 italic">
            <span class="font-semibold">Purpose:</span>
            To identify the minimum set of stakeholders whose actions are required.
          </p>
        </div>
      </div>
      <div class="mb-8">
        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Available Actors</p>
        <div id="stakeholderPool" class="flex flex-wrap gap-3 p-4 bg-slate-50 rounded-xl border border-slate-100 min-h-[80px] items-center">
        <div draggable="true" ondragstart="drag(event)" class="stakeholder-chip" data-name="Teacher">Teacher</div>
        <div draggable="true" ondragstart="drag(event)" class="stakeholder-chip" data-name="Head Master">Head Master</div>
        <div draggable="true" ondragstart="drag(event)" class="stakeholder-chip" data-name="CRP">CRP</div>
        <div draggable="true" ondragstart="drag(event)" class="stakeholder-chip" data-name="BRP">BRP</div>
        <div draggable="true" ondragstart="drag(event)" class="stakeholder-chip" data-name="DIET">DIET</div>
        <div draggable="true" ondragstart="drag(event)" class="stakeholder-chip" data-name="District Education Officer">District Education Officer</div>
        <!-- <div draggable="true" ondragstart="drag(event)" class="stakeholder-chip" data-name="Parent">Parent</div>
        <div draggable="true" ondragstart="drag(event)" class="stakeholder-chip" data-name="SMC Member">SMC Member</div> -->
      </div>
      </div>
      <div class="flex-grow">
        <div class="flex justify-between items-end mb-3">
          <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Ecosystem-MAP</p>
          <p class="text-xs text-indigo-500 font-medium animate-pulse hidden" id="dragHint">Drop here to map</p>
        </div>
        <div id="systemMap" ondrop="drop(event)" ondragover="allowDrop(event)"
          class="relative w-full h-64 bg-indigo-50/50 border-2 border-dashed border-indigo-200 rounded-2xl flex items-center justify-center transition-all duration-300 hover:border-indigo-400 hover:bg-indigo-50">
          <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-20">
            <div class="w-[90%] h-[90%] border border-indigo-400 rounded-full absolute"></div>
            <div class="w-[65%] h-[65%] border border-indigo-400 rounded-full absolute"></div>
            <div class="w-[40%] h-[40%] border border-indigo-400 rounded-full absolute bg-indigo-100/30"></div>
          </div>
          <div class="absolute text-xs font-bold text-indigo-300 pointer-events-none uppercase tracking-widest z-0">
          </div>
          <div id="droppedContainer"
            class="relative z-10 flex flex-wrap gap-4 justify-center p-6 w-full h-full content-center"> <span
              id="emptyStateText" class="text-sm text-slate-400 pointer-events-none"> Drag stakeholders into the orbit
            </span> </div>
        </div>
      </div>
      <div class="mt-8 flex items-center justify-between border-t border-slate-100 pt-6"> <button onclick="goBack()"
          class="flex items-center gap-2 px-5 py-2.5 rounded-full text-slate-500 hover:bg-slate-100 hover:text-slate-700 font-medium transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
              d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
              clip-rule="evenodd" />
          </svg> Back </button> <button id="continueBtn" disabled onclick="saveAndNext()"
          class="px-8 py-3 rounded-xl font-bold text-white shadow-lg transition-all transform active:scale-95 flex items-center gap-2 disabled:bg-slate-200 disabled:text-slate-400 disabled:shadow-none disabled:cursor-not-allowed bg-indigo-600 hover:bg-indigo-700 hover:shadow-indigo-500/30">
          Continue <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
              d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z"
              clip-rule="evenodd" />
          </svg> </button> </div>
    </section>
    <aside id="rightPanel" class="space-y-6 transition-all duration-500">
      <div
        class="bg-white rounded-2xl shadow-lg border border-indigo-100 overflow-hidden flex flex-col h-auto min-h-[350px]">
        <div
          class="bg-gradient-to-r from-indigo-50 to-white px-5 py-3 border-b border-indigo-50 flex items-center justify-between">
          <div class="flex items-center gap-2">
            <div id="aiAvatarContainer"
              class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-lg shadow-sm border border-indigo-200 relative">
              <span id="aiFace">ðŸ¤–</span>
              <div id="aiPulse" class="absolute inset-0 rounded-full border border-indigo-300 opacity-0"></div>
            </div>
            <div>
              <h2 class="text-sm font-bold text-slate-800">System Analyst</h2>
              <p class="text-[10px] text-slate-500 uppercase tracking-wider font-medium">Real-time Check</p>
            </div>
          </div>
          <div id="statusLight" class="w-2 h-2 rounded-full bg-slate-300"></div>
        </div>
        <div class="p-5 flex-1 bg-slate-50/50 relative flex flex-col">
          <div id="thinkingIndicator" class="hidden items-center gap-2 text-xs text-indigo-500 font-medium mb-3">
            <span>Analyzing ecosystem</span>
            <div class="thinking-dots"><span></span><span></span><span></span></div>
          </div>
          <div
            class="bg-white p-4 rounded-xl rounded-tl-none border border-slate-200 shadow-sm text-sm text-slate-600 leading-relaxed relative flex-grow">
            <div id="aiFeedback" class="min-h-[40px] ai-markdown"> Awaiting input. Who needs to act for this change?
            </div>
            <div
              class="absolute top-0 -left-2 w-3 h-3 bg-white border-l border-t border-slate-200 transform -rotate-45">
            </div>
          </div>
        </div>
      </div>
      <div class="bg-slate-900 rounded-2xl shadow-lg p-6 text-white relative overflow-hidden">
        <div class="flex justify-between items-end mb-2"> <span
            class="text-slate-400 text-xs font-semibold uppercase tracking-wider">Map Complexity</span> <span
            id="scoreText" class="text-2xl font-bold text-indigo-400">0/2</span> </div>
        <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden">
          <div id="complexityBar"
            class="h-full bg-gradient-to-r from-indigo-400 to-violet-400 w-0 transition-all duration-500 ease-out">
          </div>
        </div>
        <div class="mt-4 flex gap-2 text-xs text-slate-400"> <span>ðŸ”—</span> <span>Connect at least 2 key actors</span>
        </div>
      </div>
    </aside>
  </main>
  <style>
    /* Chips Styling */
    .stakeholder-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 9999px;
      background: white;
      border: 1px solid #e2e8f0;
      color: #475569;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: grab;
      user-select: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .stakeholder-chip:hover {
      border-color: #818cf8;
      color: #4338ca;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
    }

    .stakeholder-chip:active {
      cursor: grabbing;
      transform: scale(0.95);
    }

    #droppedContainer .stakeholder-chip {
      background: #eef2ff;
      border-color: #6366f1;
      color: #312e81;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    #droppedContainer .stakeholder-chip::after {
      content: "âœ•";
      font-size: 10px;
      margin-left: 8px;
      opacity: 0.5;
    }

    #droppedContainer .stakeholder-chip:hover::after {
      opacity: 1;
      color: red;
    }

    @keyframes pop-in {
      0% {
        transform: scale(0);
        opacity: 0;
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
  </style>
  <script>
    /* ================= INIT ================= */
  
    const STAKEHOLDER_BACKEND_URL =
      "https://shivam-99x-shikshamanthan-stakeholder-backend.hf.space/analyze-stakeholders";
  
    fetch("components/header.html")
      .then(r => r.text())
      .then(h => {
        document.getElementById("header").innerHTML = h.replace(/teal/g, "indigo");
        if (typeof setProgress === "function") setProgress(42);
      });
  
    window.onload = () => {
      if (typeof loadData === "function") loadData();
      lfaData.stakeholders = [];
      if (typeof saveData === "function") saveData();
      updateState();
    };
  
    let typeWriterInterval;
  
    /* ================= DRAG & DROP LOGIC ================= */
  
    function allowDrop(ev) {
      ev.preventDefault();
      document
        .getElementById("systemMap")
        .classList.add("bg-indigo-50", "border-indigo-400");
      document.getElementById("dragHint").classList.remove("hidden");
    }
  
    document.getElementById("systemMap").addEventListener("dragleave", () => {
      document
        .getElementById("systemMap")
        .classList.remove("bg-indigo-50", "border-indigo-400");
      document.getElementById("dragHint").classList.add("hidden");
    });
  
    function drag(ev) {
      ev.dataTransfer.setData("text", ev.target.innerText);
      ev.dataTransfer.effectAllowed = "copy";
    }
  
    function drop(ev) {
      ev.preventDefault();
      const rawText = ev.dataTransfer.getData("text");
  
      document
        .getElementById("systemMap")
        .classList.remove("bg-indigo-50", "border-indigo-400");
      document.getElementById("dragHint").classList.add("hidden");
  
      if (!lfaData.stakeholders.includes(rawText)) {
        lfaData.stakeholders.push(rawText);
        addStakeholderToMap(rawText);
        updateState();
      }
    }
  
    function addStakeholderToMap(name) {
      const container = document.getElementById("droppedContainer");
      const emptyText = document.getElementById("emptyStateText");
  
      if (emptyText) emptyText.style.display = "none";
  
      const chip = document.createElement("div");
      chip.className = "stakeholder-chip";
      chip.innerText = name;
      chip.title = "Click to remove";
  
      chip.onclick = () => {
        chip.style.transform = "scale(0)";
        setTimeout(() => {
          chip.remove();
          lfaData.stakeholders = lfaData.stakeholders.filter(s => s !== name);
          updateState();
  
          if (lfaData.stakeholders.length === 0 && emptyText) {
            emptyText.style.display = "block";
          }
  
          if (lfaData.stakeholders.length < 2) {
            resetLayout();
          }
        }, 200);
      };
  
      container.appendChild(chip);
    }
  
    /* ================= STATE & AI FEEDBACK ================= */
  
    function updateState() {
      const count = lfaData.stakeholders.length;
      const score = Math.min(count, 2);
      const widthPct = (score / 2) * 100;
  
      document.getElementById("complexityBar").style.width = widthPct + "%";
      document.getElementById("scoreText").innerText = count + "/2+";
  
      const statusLight = document.getElementById("statusLight");
  
      if (count === 0) {
        updateFeedback(
          "âš ï¸ Select at least one stakeholder to begin mapping.",
          "text-slate-500"
        );
        lockContinue();
        updateVisuals("ðŸ¤”", false);
        statusLight.classList.remove(
          "bg-green-500",
          "animate-pulse",
          "bg-yellow-400"
        );
        statusLight.classList.add("bg-slate-300");
        return;
      }
  
      if (count === 1) {
        updateFeedback(
          "ðŸŸ¡ Good start. Change usually requires more than one actor.",
          "text-yellow-600"
        );
        lockContinue();
        updateVisuals("ðŸ§", false);
        statusLight.classList.remove(
          "bg-green-500",
          "animate-pulse",
          "bg-slate-300"
        );
        statusLight.classList.add("bg-yellow-400");
        return;
      }
  
      /* Success State */
      updateVisuals("ðŸ¤", false);
      unlockContinue();
      statusLight.classList.remove("bg-slate-300", "bg-yellow-400");
      statusLight.classList.add("bg-green-500", "animate-pulse");
  
      shiftLayoutForFocus();
      analyzeStakeholdersWithLLM();
    }
  
    /* ================= LAYOUT SHIFT LOGIC ================= */
  
    function shiftLayoutForFocus() {
      if (window.innerWidth >= 1024) {
        const grid = document.getElementById("mainGrid");
        grid.classList.remove("lg:grid-cols-[2fr_1fr]");
        grid.style.gridTemplateColumns = "1fr 1fr";
      }
    }
  
    function resetLayout() {
      if (window.innerWidth >= 1024) {
        const grid = document.getElementById("mainGrid");
        grid.style.gridTemplateColumns = "";
        grid.classList.add("lg:grid-cols-[2fr_1fr]");
      }
    }
  
    /* ================= MARKDOWN & TYPEWRITER ================= */
  
    function parseMarkdown(text) {
      if (!text) return "";
  
      let html = text;
  
      html = html.replace(/^### (.*?)(\n|$)/gm, "<h3>$1</h3>");
      html = html.replace(/^## (.*?)(\n|$)/gm, "<h3>$1</h3>");
      html = html.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
      html = html.replace(/^\- (.*?)(\n|$)/gm, "<li>$1</li>");
      html = html.replace(/\n/g, "<br>");
  
      return html;
    }
  
    function typeWriter(text, element) {
      clearInterval(typeWriterInterval);
      element.innerHTML = "";
      element.classList.add("cursor");
  
      const formattedHTML = parseMarkdown(text);
  
      if (formattedHTML.includes("<")) {
        element.innerHTML = formattedHTML;
        element.classList.remove("cursor");
        element.style.opacity = 0;
  
        let op = 0;
        const fadeInt = setInterval(() => {
          if (op >= 1) clearInterval(fadeInt);
          element.style.opacity = op;
          op += 0.1;
        }, 30);
        return;
      }
  
      let i = 0;
      typeWriterInterval = setInterval(() => {
        if (i < text.length) {
          element.innerHTML += text.charAt(i);
          i++;
        } else {
          clearInterval(typeWriterInterval);
          element.classList.remove("cursor");
        }
      }, 5);
    }
  
    /* ================= UI HELPERS ================= */
  
    function updateVisuals(emoji, isThinking) {
      document.getElementById("aiFace").innerText = emoji;
      const pulse = document.getElementById("aiPulse");
  
      if (isThinking) {
        pulse.classList.add("ai-thinking", "opacity-100");
      } else {
        pulse.classList.remove("ai-thinking", "opacity-100");
      }
    }
  
    function updateFeedback(msg, colorClass, useTypewriter = false) {
      const fb = document.getElementById("aiFeedback");
      fb.className = `text-sm font-medium min-h-[3rem] ai-markdown ${colorClass}`;
  
      if (useTypewriter) {
        typeWriter(msg, fb);
      } else {
        clearInterval(typeWriterInterval);
        fb.innerHTML = parseMarkdown(msg);
      }
    }
  
    function showThinking(show) {
      const indicator = document.getElementById("thinkingIndicator");
  
      if (show) {
        indicator.classList.remove("hidden");
        indicator.classList.add("flex");
        document.getElementById("aiFeedback").innerHTML = "";
      } else {
        indicator.classList.add("hidden");
        indicator.classList.remove("flex");
      }
    }
  
    /* ================= AI LOGIC ================= */
  
    async function analyzeStakeholdersWithLLM() {
      if (!lfaData.stakeholders || lfaData.stakeholders.length < 2) return;
  
      showThinking(true);
      updateVisuals("ðŸ¤–", true);
  
      try {
        const res = await fetch(STAKEHOLDER_BACKEND_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            stakeholders: lfaData.stakeholders,
            category: lfaData.program?.theme || "General Education",
            subject: lfaData.program?.name || "Education Initiative",
            topic: lfaData.program?.level || "System Level",
            description: lfaData.problem || "No description provided"
          })
        });
  
        const data = await res.json();
        showThinking(false);
        updateVisuals("ðŸ¤“", false);
  
        updateFeedback(data.response, "text-slate-700", true);
        lfaData.stakeholderAnalysis = data.response;
  
        if (typeof saveData === "function") saveData();
      } catch (err) {
        showThinking(false);
        updateVisuals("ðŸ˜µ", false);
        updateFeedback(
          "âŒ Could not analyze stakeholders. Please try again.",
          "text-red-500"
        );
        console.error(err);
      }
    }
  
    /* ================= NAV ================= */
  
    function unlockContinue() {
      const b = document.getElementById("continueBtn");
      b.disabled = false;
      b.classList.remove("bg-slate-200", "text-slate-400", "cursor-not-allowed");
      b.classList.add(
        "bg-indigo-600",
        "hover:bg-indigo-700",
        "text-white",
        "shadow-lg",
        "hover:-translate-y-1"
      );
    }
  
    function lockContinue() {
      const b = document.getElementById("continueBtn");
      b.disabled = true;
      b.classList.add("bg-slate-200", "text-slate-400", "cursor-not-allowed");
      b.classList.remove(
        "bg-indigo-600",
        "hover:bg-indigo-700",
        "text-white",
        "shadow-lg",
        "hover:-translate-y-1"
      );
    }
  
    function saveAndNext() {
      if (lfaData.stakeholders.length < 2) {
        alert("Please map more than one stakeholder.");
        return;
      }
      if (typeof saveData === "function") saveData();
      window.location.href = "level5.html";
    }
  
    function goBack() {
      window.location.href = "level3.html";
    }
  </script>
  </body>

</html>
