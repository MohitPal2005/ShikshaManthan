<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Level 6 ‚Äì Activities | ShikshaManthan</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script src="assets/js/data.js"></script>
  <script src="assets/js/progress.js"></script>

  <style>
    body { font-family: 'Poppins', sans-serif; }

    /* Background Pattern */
    .bg-grid-pattern {
        background-image: radial-gradient(#6366f1 0.5px, transparent 0.5px);
        background-size: 24px 24px;
        opacity: 0.1;
    }

    /* AI Animations */
    @keyframes pulse-ring {
        0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
        100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
    }
    .ai-thinking { animation: pulse-ring 2s infinite; }

    /* Progress Bar Override */
    #progressBar, .progress-bar-fill { background-color: #4f46e5 !important; }
    
    /* Animation for New Cards */
    @keyframes slide-down {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-slide-down { animation: slide-down 0.3s ease-out forwards; }
  </style>
</head>

<body class="bg-slate-50 min-h-screen relative text-slate-800">

<div class="fixed inset-0 bg-grid-pattern pointer-events-none z-0"></div>

<div id="header" class="relative z-20 sticky top-0 bg-white/90 backdrop-blur shadow-sm"></div>

<main class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 mb-20 grid grid-cols-1 lg:grid-cols-3 gap-8">

  <section class="lg:col-span-2 bg-white rounded-2xl shadow-xl border border-slate-100 p-6 sm:p-8 relative overflow-hidden flex flex-col h-full">
    
    <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-indigo-500 via-violet-500 to-indigo-500"></div>

    <div class="mb-8">
      <div class="flex items-center gap-3 mb-2">
        <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-bold uppercase tracking-wide">Level 6</span>
        <span class="text-slate-400 text-sm font-medium">Implementation</span>
      </div>
      <h1 class="text-2xl sm:text-3xl font-bold text-slate-800 leading-tight">
        As a Stakeholder what will you do to Achieve Success ?
      </h1>
      <p class="text-slate-500 mt-2 text-sm sm:text-base">
        Add specific activities (training, coaching, meetings) that directly support the <strong class="text-indigo-600">practice changes</strong> you defined.
      </p>
    </div>

    <div id="activityContainer" class="space-y-6">
        </div>

    <button onclick="addActivity()"
      class="mt-6 w-full py-3 border-2 border-dashed border-indigo-200 rounded-xl text-indigo-500 font-medium hover:bg-indigo-50 hover:border-indigo-400 transition-all flex items-center justify-center gap-2">
      <span class="text-xl">+</span> Add another activity
    </button>

    <div class="mt-10 flex items-center justify-between border-t border-slate-100 pt-6">
      <button onclick="goBack()"
        class="flex items-center gap-2 px-5 py-2.5 rounded-full text-slate-500 hover:bg-slate-100 hover:text-slate-700 font-medium transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        Back
      </button>

      <button id="continueBtn"
        disabled
        onclick="saveAndNext()"
        class="px-8 py-3 rounded-xl font-bold text-white shadow-lg transition-all transform active:scale-95 flex items-center gap-2 disabled:bg-slate-200 disabled:text-slate-400 disabled:shadow-none disabled:cursor-not-allowed bg-indigo-600 hover:bg-indigo-700 hover:shadow-indigo-500/30">
        Continue
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>

  </section>

  <aside class="lg:col-span-1 space-y-6">
    
    <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6 text-center relative overflow-hidden">
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-100 rounded-full blur-2xl opacity-60 pointer-events-none"></div>

        <div id="aiAvatarContainer" class="relative mx-auto w-20 h-20 mb-4 flex items-center justify-center">
            <div id="aiPulse" class="absolute inset-0 rounded-full border-2 border-indigo-100"></div>
            <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-violet-600 rounded-full flex items-center justify-center text-2xl shadow-lg text-white z-10 transition-transform duration-300" id="aiFace">
                ü§ñ
            </div>
        </div>

        <h2 class="text-lg font-bold text-slate-800">Action Plan Check</h2>
        <div class="h-1 w-10 bg-indigo-100 mx-auto rounded-full my-3"></div>
        
        <div id="aiFeedback" class="text-sm text-slate-500 italic min-h-[3rem] transition-colors duration-300">
          "Link every activity to a specific behavior change."
        </div>
    </div>

    <div class="bg-slate-900 rounded-2xl shadow-lg p-6 text-white relative overflow-hidden">
        <h3 class="font-semibold text-indigo-300 mb-4 flex items-center gap-2">
            <span>üß©</span> Answers For Your Reference
        </h3>
        
        <div class="space-y-2.5" id="patternList">
             </div>
        
        <p class="text-xs text-slate-400 mt-4">
            Click a blueprint to auto-add it.
        </p>
    </div>

  </aside>

</main>

<script>
/* ================= INIT ================= */

fetch("components/header.html")
  .then(r => r.text())
  .then(h => {
    document.getElementById("header").innerHTML = h.replace(/teal/g, "indigo");
    if(typeof setProgress === 'function') setProgress(70);
    
    // Check Data
    loadData();

    // Guard
    if (!isLevel5Complete()) {
        // Uncomment in production
        // window.location.href = "level5.html";
        // return;
    }

    lfaData.activities = lfaData.activities || [];
    renderActivities();
    loadPatterns();
  });

/* ================= GUARD ================= */

function isLevel5Complete() {
  if(typeof lfaData === 'undefined') return false;
  return lfaData.practiceChanges && Object.keys(lfaData.practiceChanges).length > 0;
}

/* ================= RENDER ================= */

function renderActivities() {
  const container = document.getElementById("activityContainer");
  container.innerHTML = "";

  if (lfaData.activities.length === 0) {
    addActivity();
    return;
  }

  lfaData.activities.forEach((act, idx) => {
    container.appendChild(createActivityBox(act, idx));
  });
  
  evaluateState();
}

function createActivityBox(activity, index) {
  const box = document.createElement("div");
  box.className = "animate-slide-down border border-slate-200 rounded-xl p-5 bg-indigo-50/30 hover:border-indigo-300 transition-all shadow-sm relative group";

  // Trash Icon (Only show if more than 1 activity to prevent empty state issues)
  const deleteBtn = lfaData.activities.length > 1 ? `
    <button onclick="removeActivity(${index})" class="absolute top-4 right-4 text-slate-400 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100">
        üóëÔ∏è
    </button>` : '';

  // Dropdown Options
  const practiceOptions = Object.keys(lfaData.practiceChanges || {})
    .map(p => `<option value="${p}" ${activity.practice === p ? "selected" : ""}>Link to: ${p} (${lfaData.practiceChanges[p].substring(0, 30)}...)</option>`)
    .join("");

  box.innerHTML = `
    ${deleteBtn}
    <div class="flex flex-col gap-3">
        <div class="relative">
             <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-indigo-400">
                üîó
             </div>
             <select
               class="w-full pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-lg text-sm text-slate-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none appearance-none cursor-pointer"
               onchange="updateActivity(${index}, 'practice', this.value)">
               <option value="">-- Select Goal this Activity Supports --</option>
               ${practiceOptions}
             </select>
        </div>

        <textarea
          rows="3"
          placeholder="Describe the activity (e.g., Monthly mentoring circle for teachers)..."
          class="w-full p-3 bg-white border border-slate-200 rounded-lg text-slate-700 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none transition-all"
          oninput="updateActivity(${index}, 'text', this.value)"
        ></textarea>
    </div>
  `;

  return box;
}

/* ================= ACTIONS ================= */

function addActivity() {
  lfaData.activities.push({ practice: "", text: "" });
  renderActivities();
}

function removeActivity(index) {
    lfaData.activities.splice(index, 1);
    renderActivities();
}

function updateActivity(index, field, value) {
  lfaData.activities[index][field] = value.trim();
  evaluateState();
}



/* ================= STATE EVALUATION ================= */


function evaluateState() {
  const invalid = lfaData.activities.some(a => !a.practice || !a.text || a.text.length < 15);

  if (invalid) {
    updateFeedback("‚ö†Ô∏è Ensure every activity is described clearly (>15 chars) and linked to a goal.", "text-yellow-600", "üßê");
    lockContinue();
    return;
  }

  const meaningless = lfaData.activities.some(a =>
    a.text && a.text.trim().length > 0 && isMeaninglessText(a.text)
  );

  if (meaningless) {
    alert("Your input is not related to Education System");
    lockContinue();
    return;
  }

  updateFeedback("‚úÖ Perfect! Your action plan is actionable and aligned.", "text-green-600", "üöÄ");
  unlockContinue();
}


function updateFeedback(msg, colorClass, emoji) {
    const fb = document.getElementById("aiFeedback");
    const face = document.getElementById("aiFace");
    const pulse = document.getElementById("aiPulse");
    
    fb.innerText = msg;
    fb.className = `text-sm font-medium min-h-[3rem] transition-colors duration-300 ${colorClass}`;
    
    face.innerText = emoji;
    
    if(emoji === "üöÄ" || emoji === "‚úÖ") {
        pulse.classList.remove("ai-thinking");
        pulse.classList.add("bg-green-100");
    } else {
        pulse.classList.add("ai-thinking");
        pulse.classList.remove("bg-green-100");
    }
}

/* ================= PATTERNS ================= */

function loadPatterns() {
  const list = document.getElementById("patternList");
  list.innerHTML = "";

  const patterns = [
    { title: "Classroom Observation & Feedback(CRP)", desc: "I will invite CRP for classroom observation to focus on instructional challenges" },
    { title: "Subject-Specific Mentoring (BRP)", desc: "I will connect with BRP for subject-level guidance, content clarification" },
    { title: "Reporting to DEO", desc: "I will formally reports issues such as infrastructure gaps,workload" },
    { title: "Parent-Teacher Meeting", desc: "I will meet parents every month to explain their child‚Äôs strengths, weaknesses" }
  ];

  patterns.forEach(p => {
    const btn = document.createElement("button");
    btn.className = "w-full text-left px-4 py-3 bg-slate-800 hover:bg-slate-700 rounded-xl transition-colors text-sm group";
    btn.innerHTML = `
        <div class="font-semibold text-indigo-300 group-hover:text-indigo-200">${p.title}</div>
        <div class="text-xs text-slate-400 truncate">${p.desc}</div>
    `;
    btn.onclick = () => addPattern(p.title + ": " + p.desc);
    list.appendChild(btn);
  });
}

function addPattern(text) {
  // If last activity is empty, fill it. Otherwise add new.
  const last = lfaData.activities[lfaData.activities.length - 1];
  if(last && last.text === "") {
      last.text = text;
  } else {
      lfaData.activities.push({ practice: "", text });
  }
  renderActivities();
}

/* ================= BUTTON STATES ================= */

function unlockContinue() {
  const b = document.getElementById("continueBtn");
  b.disabled = false;
  b.classList.remove("bg-slate-200", "text-slate-400");
  b.classList.add("bg-indigo-600", "hover:bg-indigo-700", "text-white", "shadow-lg", "hover:-translate-y-1");
}

function lockContinue() {
  const b = document.getElementById("continueBtn");
  b.disabled = true;
  b.classList.add("bg-slate-200", "text-slate-400");
  b.classList.remove("bg-indigo-600", "hover:bg-indigo-700", "text-white", "shadow-lg", "hover:-translate-y-1");
}

/* ================= NAV ================= */

function saveAndNext() {
  saveData();
  window.location.href = "level7.html";
}

function goBack() {
  window.location.href = "level5.html";
}

function isMeaninglessText(text) {
  if (!text || text.trim().length < 5) return false; 
  // ‚¨ÜÔ∏è prevents alert on page load

  const words = text.trim().split(/\s+/);

  // words without vowels OR very short words are usually random
  const randomWords = words.filter(w => w.length < 4 || !/[aeiou]/i.test(w));

  return (randomWords.length / words.length) > 0.6;
}


</script>

</body>
</html>
