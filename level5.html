<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Level 5 ‚Äì Practice Change | ShikshaManthan</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script src="assets/js/data.js"></script>
  <script src="assets/js/progress.js"></script>

  <style>
    body { font-family: 'Poppins', sans-serif; }

    /* Background Pattern */
    .bg-grid-pattern {
        background-image: radial-gradient(#6366f1 0.5px, transparent 0.5px);
        background-size: 24px 24px;
        opacity: 0.1;
    }

    /* AI Animations */
    @keyframes pulse-ring {
        0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
        100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
    }
    .ai-thinking { animation: pulse-ring 2s infinite; }

    /* Progress Bar Override */
    #progressBar, .progress-bar-fill { background-color: #4f46e5 !important; }
    
    /* Smooth height transition for inputs */
    textarea { transition: all 0.2s ease; }
    textarea:focus { height: 120px; }
  </style>
</head>

<body class="bg-slate-50 min-h-screen relative text-slate-800">

<div class="fixed inset-0 bg-grid-pattern pointer-events-none z-0"></div>

<div id="header" class="relative z-20 sticky top-0 bg-white/90 backdrop-blur shadow-sm"></div>

<main class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 mb-20 grid grid-cols-1 lg:grid-cols-3 gap-8">

  <section class="lg:col-span-2 bg-white rounded-2xl shadow-xl border border-slate-100 p-6 sm:p-8 relative overflow-hidden flex flex-col h-full">
    
    <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-indigo-500 via-violet-500 to-indigo-500"></div>

    <div class="mb-8">
      <div class="flex items-center gap-3 mb-2">
        <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-bold uppercase tracking-wide">Level 5</span>
        <span class="text-slate-400 text-sm font-medium">Behavior Shift</span>
      </div>
      <h1 class="text-2xl sm:text-3xl font-bold text-slate-800 leading-tight">
        What should each stakeholder do differently?
      </h1>
      <p class="text-slate-500 mt-2 text-sm sm:text-base">
        Define the specific <strong>behavior or practice change</strong> required (not just one-time activities).
      </p>
    </div>

    <div id="practiceContainer" class="space-y-6">
        </div>

    <div class="mt-10 flex items-center justify-between border-t border-slate-100 pt-6">
      <button onclick="goBack()"
        class="flex items-center gap-2 px-5 py-2.5 rounded-full text-slate-500 hover:bg-slate-100 hover:text-slate-700 font-medium transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        Back
      </button>

      <button id="continueBtn"
        disabled
        onclick="saveAndNext()"
        class="px-8 py-3 rounded-xl font-bold text-white shadow-lg transition-all transform active:scale-95 flex items-center gap-2 disabled:bg-slate-200 disabled:text-slate-400 disabled:shadow-none disabled:cursor-not-allowed bg-indigo-600 hover:bg-indigo-700 hover:shadow-indigo-500/30">
        Continue
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>

  </section>

  <aside class="lg:col-span-1 space-y-6">
    
    <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6 text-center relative overflow-hidden">
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-100 rounded-full blur-2xl opacity-60 pointer-events-none"></div>

        <div id="aiAvatarContainer" class="relative mx-auto w-20 h-20 mb-4 flex items-center justify-center">
            <div id="aiPulse" class="absolute inset-0 rounded-full border-2 border-indigo-100"></div>
            <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-violet-600 rounded-full flex items-center justify-center text-2xl shadow-lg text-white z-10 transition-transform duration-300" id="aiFace">
                ü§ñ
            </div>
        </div>

        <h2 class="text-lg font-bold text-slate-800">Behavior Check</h2>
        <div class="h-1 w-10 bg-indigo-100 mx-auto rounded-full my-3"></div>
        
        <div id="aiFeedback" class="text-sm text-slate-500 italic min-h-[3rem] transition-colors duration-300">
          "Define how each stakeholder‚Äôs behaviour needs to change."
        </div>
    </div>

    <div class="bg-slate-900 rounded-2xl shadow-lg p-6 text-white relative overflow-hidden">
        <div class="flex justify-between items-end mb-2">
            <span class="text-slate-400 text-xs font-semibold uppercase tracking-wider">Completion</span>
            <span id="scoreText" class="text-2xl font-bold text-indigo-400">0%</span>
        </div>
        
        <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden">
            <div id="completionBar" class="h-full bg-gradient-to-r from-indigo-400 to-violet-400 w-0 transition-all duration-500 ease-out"></div>
        </div>
        
        <div class="mt-4 flex gap-2 text-xs text-slate-400">
           <span>‚ö°</span>
           <span>Avoid words like "Training"</span>
        </div>
    </div>

  </aside>

</main>

<script>
/* ================= INIT ================= */

fetch("components/header.html")
  .then(r => r.text())
  .then(h => {
    document.getElementById("header").innerHTML = h.replace(/teal/g, "indigo");
    if(typeof setProgress === 'function') setProgress(56);
    
    // Check Data
    loadData();

    // Guard
    if (!isLevel4Complete()) {
        // Uncomment in production
        // window.location.href = "level4.html";
        // return;
    }

    renderPracticeInputs();
  });

/* ================= GUARD ================= */

function isLevel4Complete() {
  if(typeof lfaData === 'undefined') return false;
  return lfaData.stakeholders && lfaData.stakeholders.length >= 2;
}

/* ================= RENDER ================= */

function renderPracticeInputs() {
  const container = document.getElementById("practiceContainer");
  container.innerHTML = "";

  lfaData.practiceChanges = lfaData.practiceChanges || {};

  lfaData.stakeholders.forEach((stakeholder, index) => {
    // Generate Initials
    const initials = stakeholder.split(" ").map(n => n[0]).join("").slice(0, 2).toUpperCase();
    const existingVal = lfaData.practiceChanges[stakeholder] || "";

    const card = document.createElement("div");
    card.className = "group border border-slate-200 rounded-2xl p-5 bg-white shadow-sm hover:shadow-md hover:border-indigo-200 transition-all duration-300 flex gap-4 items-start";
    
    card.innerHTML = `
      <div class="shrink-0 w-10 h-10 rounded-full bg-indigo-50 text-indigo-600 font-bold flex items-center justify-center text-sm shadow-inner mt-1">
        ${initials}
      </div>

      <div class="flex-grow">
        <label class="block text-sm font-bold text-slate-700 mb-1">${stakeholder}</label>
        
        <div class="relative">
            <textarea
              rows="2"
              placeholder="e.g. ${stakeholder} regularly observes classrooms and provides feedback..."
              class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 placeholder-slate-400 focus:bg-white focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 resize-none"
              oninput="handlePracticeChange('${stakeholder}', this.value, ${index})"
              id="input-${index}"
            >${existingVal}</textarea>
            
            <div id="status-${index}" class="absolute right-3 bottom-3 text-lg opacity-0 transition-opacity"></div>
        </div>
      </div>
    `;

    container.appendChild(card);
  });
  
  // Initial Check if data exists
  evaluateState();
}

/* ================= CORE LOGIC ================= */

function handlePracticeChange(stakeholder, text, index) {
  text = text.trim();
  lfaData.practiceChanges[stakeholder] = text;

  // Local Visual Validation per input
  const statusEl = document.getElementById(`status-${index}`);
  const activityWords = ["training", "workshop", "session", "meeting"];
  
  if(text.length === 0) {
      statusEl.style.opacity = "0";
  } else if (text.length < 15) {
      statusEl.innerHTML = "‚ö†Ô∏è"; // Too short
      statusEl.title = "Too short";
      statusEl.style.opacity = "1";
      statusEl.className = "absolute right-3 bottom-3 text-lg text-yellow-500 transition-opacity";
  } else if (activityWords.some(w => text.toLowerCase().includes(w))) {
      statusEl.innerHTML = "üö´"; // Activity detected
      statusEl.title = "Avoid activities like training";
      statusEl.style.opacity = "1";
      statusEl.className = "absolute right-3 bottom-3 text-lg text-red-500 transition-opacity";
  } else {
      statusEl.innerHTML = "‚úÖ"; // Good
      statusEl.title = "Looks good!";
      statusEl.style.opacity = "1";
      statusEl.className = "absolute right-3 bottom-3 text-lg text-green-500 transition-opacity";
  }

  evaluateState();
}

/* ================= STATE EVALUATION ================= */

function evaluateState() {
  const missing = [];
  const activityWords = ["training", "workshop", "session", "meeting"];
  let badBehavior = null;
  
  let validCount = 0;
  const total = lfaData.stakeholders.length;

  for (const s of lfaData.stakeholders) {
    const val = lfaData.practiceChanges[s];

    if (!val || val.length < 15) {
      missing.push(s);
      continue;
    }

    if (activityWords.some(w => val.toLowerCase().includes(w))) {
      badBehavior = s;
      continue; // Don't count as valid
    }
    
    validCount++;
  }

  // Update Progress Bar
  const pct = Math.round((validCount / total) * 100);
  document.getElementById("completionBar").style.width = pct + "%";
  document.getElementById("scoreText").innerText = pct + "%";

  // AI Feedback Logic
  if (badBehavior) {
    updateFeedback(`üö´ Practice for ${badBehavior} sounds like an activity (training/workshop). Describe the behavior change instead.`, "text-red-500", "üôÖ‚Äç‚ôÇÔ∏è");
    lockContinue();
    return;
  }

  if (missing.length > 0) {
    // Determine message based on how many missing
    if(validCount === 0) {
        updateFeedback("üìù Describe the behavior change for each stakeholder.", "text-slate-500", "ü§î");
    } else {
        updateFeedback(`üü° Still missing inputs for: ${missing.length} stakeholder(s).`, "text-yellow-600", "üßê");
    }
    lockContinue();
    return;
  }

  // Success
  updateFeedback("‚úÖ Excellent! Clear practice changes defined for all.", "text-green-600", "ü§©");
  unlockContinue();
}

function updateFeedback(msg, colorClass, emoji) {
    const fb = document.getElementById("aiFeedback");
    const face = document.getElementById("aiFace");
    const pulse = document.getElementById("aiPulse");
    
    fb.innerText = msg;
    fb.className = `text-sm font-medium min-h-[3rem] transition-colors duration-300 ${colorClass}`;
    
    face.innerText = emoji;
    
    if(emoji === "ü§©") {
        pulse.classList.remove("ai-thinking");
        pulse.classList.add("bg-green-100");
    } else {
        pulse.classList.add("ai-thinking");
        pulse.classList.remove("bg-green-100");
    }
}

/* ================= PROGRESS ================= */

function updateProgress(understanding) {
  // Global progress logic if needed, mostly handled by evaluateState visuals now
  const base = 56;
  const range = 14;
  // const pct = base + Math.round((understanding / 100) * range);
}

/* ================= BUTTON STATES ================= */

function unlockContinue() {
  const b = document.getElementById("continueBtn");
  b.disabled = false;
  b.classList.remove("bg-slate-200", "text-slate-400");
  b.classList.add("bg-indigo-600", "hover:bg-indigo-700", "text-white", "shadow-lg", "hover:-translate-y-1");
}

function lockContinue() {
  const b = document.getElementById("continueBtn");
  b.disabled = true;
  b.classList.add("bg-slate-200", "text-slate-400");
  b.classList.remove("bg-indigo-600", "hover:bg-indigo-700", "text-white", "shadow-lg", "hover:-translate-y-1");
}

/* ================= NAV ================= */

function saveAndNext() {
  saveData();
  window.location.href = "level6.html";
}

function goBack() {
  window.location.href = "level4.html";
}
</script>

</body>
</html>