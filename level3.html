<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Level 3 ‚Äì Success Definition | ShikshaManthan</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script src="assets/js/data.js"></script>
  <script src="assets/js/progress.js"></script>

  <style>
    body { font-family: 'Poppins', sans-serif; }
    .bg-grid-pattern {
        background-image: radial-gradient(#6366f1 0.5px, transparent 0.5px);
        background-size: 24px 24px;
        opacity: 0.1;
    }
    #progressBar, .progress-bar-fill { background-color: #4f46e5 !important; }
    
    /* Disabled button styling override */
    button:disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }

    /* AI Markdown Styles */
    .ai-markdown strong { 
        color: #4338ca; /* Indigo-800 */
        font-weight: 800; /* Extra bold for emphasis */
    }
    .ai-markdown ul { 
        list-style-type: disc; 
        padding-left: 1.5rem; 
        margin-top: 8px;
        margin-bottom: 12px;
    }
    .ai-markdown li {
        margin-bottom: 6px;
    }
    .ai-markdown h3 {
        font-weight: 700;
        color: #1e293b;
        margin-top: 16px;
        margin-bottom: 8px;
        font-size: 1rem;
        border-bottom: 1px solid #e0e7ff;
        padding-bottom: 4px;
    }
  </style>
</head>

<body class="bg-slate-50 min-h-screen relative text-slate-800">

<div class="fixed inset-0 bg-grid-pattern pointer-events-none z-0"></div>
<div id="header" class="relative z-20 sticky top-0 bg-white/90 backdrop-blur shadow-sm"></div>

<main class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 mb-20 grid grid-cols-1 lg:grid-cols-3 gap-8">

<section class="lg:col-span-2 bg-white rounded-2xl shadow-xl border border-slate-100 p-6 sm:p-8 relative overflow-hidden">

  <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-indigo-500 via-violet-500 to-indigo-500"></div>

  <div class="mb-6">
    <div class="flex items-center gap-3 mb-2">
      <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-bold uppercase tracking-wide">Level 3</span>
      <span class="text-slate-400 text-sm font-medium">Vision of Success</span>
    </div>

    <h1 class="text-2xl sm:text-3xl font-bold text-slate-800">
      What measurable indicators do you want to see for student-level impact?
    </h1>
    <p class="text-slate-500 mt-2">
      Describe the Measurable changes in students.
    </p>
    <div class="mt-3 bg-indigo-50 border-l-4 border-indigo-400 px-4 py-2 rounded-r-lg">
          <p class="text-xs sm:text-sm text-indigo-700 italic">
            <span class="font-semibold">Purpose:</span>
            To translate the desired student change into quantifiable indicators that can be tracked
          </p>
        </div>
  </div>

  <textarea id="successInput" rows="6"
    placeholder="Example: Students regularly read grade-level text fluently and answer comprehension questions independently..."
    class="w-full p-5 bg-slate-50 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 resize-none shadow-inner"
    oninput="handleInput(this.value)">
  </textarea>

  <div class="flex justify-between items-center mt-2">
      <div id="charCount" class="text-xs text-slate-400">0 / 70 characters required</div>
      <div id="statusBadge" class="text-xs text-slate-400">Waiting for input‚Ä¶</div>
  </div>

  <div class="mt-4 text-right">
      <button id="submitBtn" onclick="evaluateSuccess()" disabled
        class="px-6 py-2 bg-slate-800 text-white text-sm font-semibold rounded-lg shadow hover:bg-slate-900 transition-all disabled:bg-slate-300">
        Submit for Analysis ‚ö°
      </button>
  </div>
 

  <div class="mt-8 p-6 bg-indigo-50 rounded-xl border border-indigo-100">
    <div class="flex items-start gap-3">
        <svg class="w-5 h-5 text-indigo-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <div>
            <h3 class="font-semibold text-indigo-900 text-sm">Guidelines: Measurable Indicators are-</h3>
            <ul class="mt-3 space-y-2 text-sm text-indigo-800 list-disc list-outside ml-4">
                <li>Academic Achievement such as Marks in written tests.</li>
                <li>Skill-based Measures such as reading accuracy, handwriting quality</li>
               
            </ul>
        </div>
    </div>
</div>


  <div class="mt-8 flex justify-between border-t pt-6">
    <button onclick="goBack()" class="px-5 py-2 rounded-full text-slate-500 hover:bg-slate-100">Back</button>
    
    <button id="continueBtn" onclick="saveAndNext()" disabled
      class="px-8 py-3 rounded-xl font-bold text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-200 disabled:text-slate-400 transition-colors">
      Continue ‚Üí
    </button>
  </div>
</section>

<aside class="space-y-6">
  <div class="bg-white rounded-2xl shadow-lg p-6 text-center">
    <div id="aiFace" class="text-3xl mb-2">ü§ñ</div>
    <h2 class="font-bold">AI Feedback</h2>
    <div id="aiFeedback" class="text-sm font-bold text-slate-500 mt-2 ai-markdown">
      "Write at least 70 characters and click Submit to get my feedback!"
    </div>
  </div>

  <div class="bg-slate-900 rounded-2xl p-6 text-white">
    <div class="flex justify-between">
      <span class="text-xs text-slate-400">Aim: Success Clarity >= 60% </span>
      <span id="scoreText" class="text-xl font-bold text-indigo-400">0%</span>
    </div>
    <div class="w-full bg-slate-700 h-2 mt-2 rounded">
      <div id="clarityBar" class="h-full bg-indigo-400 w-0 transition-all duration-1000"></div>
    </div>
  </div>
</aside>

</main>

<script>
  // Ensure data loading if needed
  if(typeof loadData === 'function') loadData();

  const BACKEND_URL = "https://shivam-99x-shikshamanthan-backend.hf.space/evaluate-success";
  
  // 1. Markdown Parser
  function parseMarkdown(text) {
    if(!text) return "";
    let html = text;
    // Headers
    html = html.replace(/^### (.*?)(\n|$)/gm, '<h3>$1</h3>');
    html = html.replace(/^## (.*?)(\n|$)/gm, '<h3>$1</h3>');
    // Bold
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    // Lists
    html = html.replace(/^\- (.*?)(\n|$)/gm, '<li>$1</li>');
    // Line breaks
    html = html.replace(/\n/g, '<br>');
    return html;
  }

  // 2. Handle User Input - Controls "Submit" Button only
  function handleInput(text) {
     lfaData.successDefinition = text;
    const currentLength = text.length;
    
    // Update Character Count UI
    const charDisplay = document.getElementById("charCount");
    charDisplay.innerText = `| Number of characters you wrote ${currentLength} |`;
    charDisplay.classList.toggle("text-green-600", currentLength >= 70);
    charDisplay.classList.toggle("text-slate-400", currentLength < 70);

    // Requirement 2: Unlock "Submit" button if text >= 70
    const submitBtn = document.getElementById("submitBtn");
    
    if (currentLength >= 70) {
        submitBtn.disabled = false;
        document.getElementById("statusBadge").innerText = "Ready to submit";
    } else {
        submitBtn.disabled = true;
        document.getElementById("statusBadge").innerText = "Keep typing...";
        lockContinue(); 
    }
  }

  // 3. API Call - Triggered ONLY by Submit Button
  async function evaluateSuccess() {
    const text = document.getElementById("successInput").value;
    const submitBtn = document.getElementById("submitBtn");
    const aiFeedbackBox = document.getElementById("aiFeedback");

    // UI Loading State
    submitBtn.innerText = "Analyzing...";
    submitBtn.disabled = true;
    
    // Reset classes for loading
    aiFeedbackBox.className = "text-sm font-bold text-slate-500 mt-2 ai-markdown";
    aiFeedbackBox.innerHTML = "ü§ñ Analyzing your definition...";
    
    document.getElementById("aiFace").innerText = "‚è≥";

    try {
        const res = await fetch(BACKEND_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            // CHANGE START: Send problem and outcome along with success_description
            body: JSON.stringify({ 
                success_description: text,
                problem: lfaData.problem,           // Variable from Level 1
                outcome: lfaData.studentOutcome     // Variable from Level 2 (User defined name)
            })
            // CHANGE END
        });

        if (!res.ok) throw new Error(`Server error: ${res.status}`);

        const data = await res.json();
        
        // --- UPDATED: Use Markdown parser & Add Bold Styling ---
        // Added 'font-bold' and changed text color to darker slate (slate-800)
        aiFeedbackBox.className = "text-sm font-bold text-slate-800 mt-2 text-left ai-markdown";
        aiFeedbackBox.innerHTML = parseMarkdown(data.evaluation);
        const match = data.evaluation.match(/Success Clarity Score \s*(\d+)%/i);
        const aiScore = match ? parseInt(match[1]) : 0;

        updateScoreUI(aiScore);

        if (aiScore >= 60) {
            unlockContinue();
            document.getElementById("aiFace").innerText = "üèÜ";
        } else {
            lockContinue();
            document.getElementById("aiFace").innerText = "ü§î";
        }

    } catch (error) {
        console.error("API Error:", error);
        aiFeedbackBox.innerText = "‚ö†Ô∏è Error connecting to AI. Please try again.";
        document.getElementById("aiFace").innerText = "‚ùå";
    } finally {
        submitBtn.innerText = "Submit for Analysis ‚ö°";
        submitBtn.disabled = false;
    }
  }

  function updateScoreUI(score) {
    document.getElementById("clarityBar").style.width = score + "%";
    document.getElementById("scoreText").innerText = score + "%";
  }

  function unlockContinue() {
    const btn = document.getElementById("continueBtn");
    btn.disabled = false;
    btn.classList.remove("bg-slate-200", "text-slate-400");
    btn.classList.add("bg-indigo-600", "text-white");
  }

  function lockContinue() {
    const btn = document.getElementById("continueBtn");
    btn.disabled = true;
    btn.classList.add("bg-slate-200", "text-slate-400");
    btn.classList.remove("bg-indigo-600", "text-white");
  }

  function saveAndNext() {
    if(typeof saveData === 'function') saveData();
    window.location.href = "level4.html";
  }

  function goBack() {
    window.location.href = "level2.html";
  }
</script>

</body>
</html>
