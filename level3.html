<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Level 3 ‚Äì Success Definition | ShikshaManthan</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script src="assets/js/data.js"></script>
  <script src="assets/js/progress.js"></script>

  <style>
    body { font-family: 'Poppins', sans-serif; }
    .bg-grid-pattern {
        background-image: radial-gradient(#6366f1 0.5px, transparent 0.5px);
        background-size: 24px 24px;
        opacity: 0.1;
    }
    @keyframes pulse-ring {
        0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
        100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
    }
    .ai-thinking { animation: pulse-ring 2s infinite; }
    #progressBar, .progress-bar-fill { background-color: #4f46e5 !important; }
  </style>
</head>

<body class="bg-slate-50 min-h-screen relative text-slate-800">

<div class="fixed inset-0 bg-grid-pattern pointer-events-none z-0"></div>
<div id="header" class="relative z-20 sticky top-0 bg-white/90 backdrop-blur shadow-sm"></div>

<main class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 mb-20 grid grid-cols-1 lg:grid-cols-3 gap-8">

<!-- ================= LEFT ================= -->
<section class="lg:col-span-2 bg-white rounded-2xl shadow-xl border border-slate-100 p-6 sm:p-8 relative overflow-hidden">

  <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-indigo-500 via-violet-500 to-indigo-500"></div>

  <div class="mb-6">
    <div class="flex items-center gap-3 mb-2">
      <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-bold uppercase tracking-wide">Level 3</span>
      <span class="text-slate-400 text-sm font-medium">Vision of Success</span>
    </div>

    <h1 class="text-2xl sm:text-3xl font-bold text-slate-800">
      What does success look like?
    </h1>
    <p class="text-slate-500 mt-2">
      Describe the final success state in observable, real-world language.
    </p>
  </div>

  <textarea id="successInput" rows="6"
    placeholder="Example: Students regularly read grade-level text fluently and answer comprehension questions independently."
    class="w-full p-5 bg-slate-50 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 resize-none shadow-inner"
    oninput="handleAIFlow(this.value)">
  </textarea>

  <div id="statusBadge" class="text-xs mt-2 text-slate-400">Waiting for input‚Ä¶</div>

  <div class="mt-8 flex justify-between border-t pt-6">
    <button onclick="goBack()" class="px-5 py-2 rounded-full text-slate-500 hover:bg-slate-100">Back</button>
    <button id="continueBtn" onclick="saveAndNext()"
      class="px-8 py-3 rounded-xl font-bold text-white disabled:bg-slate-200 bg-indigo-600 hover:bg-indigo-700">
      Continue ‚Üí
    </button>
  </div>
</section>

<!-- ================= RIGHT ================= -->
<aside class="space-y-6">
  <div class="bg-white rounded-2xl shadow-lg p-6 text-center">
    <div id="aiFace" class="text-3xl mb-2">ü§ñ</div>
    <h2 class="font-bold">AI Feedback</h2>
    <div id="aiFeedback" class="text-sm italic text-slate-500 mt-2">
      "I'm checking if your definition includes behaviour, ability, and evidence..."
    </div>
  </div>

  <div class="bg-slate-900 rounded-2xl p-6 text-white">
    <div class="flex justify-between">
      <span class="text-xs text-slate-400">Success Clarity</span>
      <span id="scoreText" class="text-xl font-bold text-indigo-400">0%</span>
    </div>
    <div class="w-full bg-slate-700 h-2 mt-2 rounded">
      <div id="clarityBar" class="h-full bg-indigo-400 w-0 transition-all"></div>
    </div>
  </div>
</aside>

</main>
<script>
  // 1. FIX: Call loadData separately
  loadData();

  // 2. FIX: Define the URL correctly
  const BACKEND_URL = "https://shivam-99x-shikshamanthan-backend.hf.space/evaluate-success";

  let aiScore = 0;
  let debounceTimer; // Variable to hold the timer

  function handleAIFlow(text) {
    lfaData.successDefinition = text.trim();
    document.getElementById("statusBadge").innerText = "Analyzing‚Ä¶";

    // Clear the previous timer so we don't spam the API
    clearTimeout(debounceTimer);

    if (text.length < 30) {
      updateUI(15, "ü§î", "Too vague. Describe observable success.");
      lockContinue();
      return;
    }

    if (text.length >= 30 && text.length < 80) {
      updateUI(45, "üìù", "Good start. Add behaviour, ability, and evidence.");
      lockContinue();
      return;
    }

    // 3. FIX: Add a delay (Debounce). Only call API if user stops typing for 1 second
    document.getElementById("aiFeedback").innerText = "Waiting for you to finish typing...";
    
    debounceTimer = setTimeout(() => {
        evaluateSuccess(text);
    }, 1000); // Wait 1000ms (1 second)
  }

  async function evaluateSuccess(text) {
    document.getElementById("aiFeedback").innerText = "ü§ñ Evaluating success clarity‚Ä¶";

    try {
        // 4. FIX: Added try/catch to handle errors gracefully
        const res = await fetch(BACKEND_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ success_description: text })
        });

        if (!res.ok) {
            throw new Error(`Server error: ${res.status}`);
        }

        const data = await res.json();
        document.getElementById("aiFeedback").innerText = data.evaluation;

        const match = data.evaluation.match(/(\d+)%/);
        aiScore = match ? parseInt(match[1]) : 0;

        updateUI(aiScore, "üèÜ", null);

        if (aiScore >= 70) unlockContinue();
        else lockContinue();

    } catch (error) {
        console.error("API Error:", error);
        document.getElementById("aiFeedback").innerText = "‚ö†Ô∏è Error connecting to AI. Please try again.";
    }
  }

  function updateUI(score, emoji, fallbackText) {
    document.getElementById("clarityBar").style.width = score + "%";
    document.getElementById("scoreText").innerText = score + "%";
    document.getElementById("aiFace").innerText = emoji;
    if (fallbackText) document.getElementById("aiFeedback").innerText = fallbackText;
  }

  function unlockContinue() {
    document.getElementById("continueBtn").disabled = false;
    // Remove the disabled styling class if needed, or rely on Tailwind's disabled: modifier
    document.getElementById("continueBtn").classList.remove("bg-slate-200");
    document.getElementById("continueBtn").classList.add("bg-indigo-600");
  }

  function lockContinue() {
    document.getElementById("continueBtn").disabled = true;
    document.getElementById("continueBtn").classList.add("bg-slate-200");
    document.getElementById("continueBtn").classList.remove("bg-indigo-600");
  }

  function saveAndNext() {
    saveData();
    window.location.href = "level4.html";
  }

  function goBack() {
    window.location.href = "level2.html";
  }
</script>

</body>
</html>
