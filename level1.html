<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Level 1 ‚Äì Problem Definition | ShikshaManthan</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script src="assets/js/data.js"></script>
  <script src="assets/js/progress.js"></script>

  <style>
    body { font-family: 'Poppins', sans-serif; }

    /* Background Pattern */
    .bg-grid-pattern {
        background-image: radial-gradient(#6366f1 0.5px, transparent 0.5px);
        background-size: 24px 24px;
        opacity: 0.1;
    }

    /* AI Pulse Animation */
    @keyframes pulse-ring {
        0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
        100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
    }
    .ai-thinking { animation: pulse-ring 2s infinite; }

    /* Progress Bar Override */
    #progressBar, .progress-bar-fill { background-color: #4f46e5 !important; }
    .progress-step-active { background-color: #4f46e5 !important; border-color: #4f46e5 !important; color: white !important; }
  </style>
</head>

<body class="bg-slate-50 min-h-screen relative text-slate-800">

<div class="fixed inset-0 bg-grid-pattern pointer-events-none z-0"></div>

<div id="header" class="relative z-20 sticky top-0 bg-white/90 backdrop-blur shadow-sm"></div>

<main class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 mb-20 grid grid-cols-1 lg:grid-cols-3 gap-8">

  <section class="lg:col-span-2 bg-white rounded-2xl shadow-xl border border-slate-100 p-6 sm:p-8 relative overflow-hidden flex flex-col justify-between">
    
    <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-indigo-500 via-violet-500 to-indigo-500"></div>

    <div>
        <div class="mb-6">
        <div class="flex items-center gap-3 mb-2">
            <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-bold uppercase tracking-wide">Level 1</span>
            <span class="text-slate-400 text-sm">Problem Definition</span>
        </div>
        <h1 id="aiQuestion" class="text-2xl sm:text-3xl font-bold text-slate-800 leading-tight transition-all duration-300">
            What is the core problem in the system?
        </h1>
        <p id="aiSubtext" class="text-slate-500 mt-2 text-sm sm:text-base transition-all duration-300">
            Describe the problem area, not solutions or activities
        </p>
          <div class="mt-3 bg-indigo-50 border-l-4 border-indigo-400 px-4 py-2 rounded-r-lg">
          <p class="text-xs sm:text-sm text-indigo-700 italic">
            <span class="font-semibold">Purpose:</span>
            To ensure the problem is defined at the system level, not as a symptom
          </p>
        </div>
        </div>

        <div class="relative group">
        <textarea
            id="problemInput"
            rows="6"
            placeholder="Type here..."
            class="w-full p-5 bg-slate-50 border-2 border-slate-200 rounded-xl text-slate-700 placeholder-slate-400 focus:bg-white focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all resize-none shadow-inner"
            oninput="handleAIFlow(this.value)"
        ></textarea>
        <div class="absolute bottom-4 right-4 transition-opacity duration-300 opacity-50 text-xs text-slate-400" id="typingStatus">
            Waiting for input...
        </div>
        </div>

        <div id="followUpContainer" class="mt-8 space-y-6 hidden border-t border-slate-100 pt-8">
            </div>

        </div>

    <div class="mt-8 flex items-center justify-between border-t border-slate-100 pt-6" id="footerActions">
      <button onclick="goBack()"
        class="flex items-center gap-2 px-5 py-2.5 rounded-full text-slate-500 hover:bg-slate-100 hover:text-slate-700 font-medium transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        Back
      </button>

      <div class="flex items-center gap-4" id="initialButtons">
        <button onclick="submitProblem()" 
            class="border-2 border-indigo-600 bg-white text-indigo-600 px-6 py-2.5 rounded-xl font-bold hover:bg-indigo-50 transition-all">
            Submit to AI
        </button>

        <button id="continueBtn"
            disabled
            onclick="saveAndNext()"
            class="px-8 py-3 rounded-xl font-bold text-white shadow-lg transition-all transform active:scale-95 flex items-center gap-2 disabled:bg-slate-200 disabled:text-slate-400 disabled:shadow-none disabled:cursor-not-allowed bg-indigo-600 hover:bg-indigo-700 hover:shadow-indigo-500/30">
            Continue
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
      </div>
    </div>

  </section>

  <aside class="lg:col-span-1">
    
    <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6 relative overflow-hidden h-full flex flex-col justify-between">
        
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-100 rounded-full blur-2xl opacity-60 pointer-events-none"></div>

        <div class="text-center relative z-10">
            <div id="aiAvatarContainer" class="relative mx-auto w-20 h-20 mb-4 flex items-center justify-center">
                <div id="aiPulse" class="absolute inset-0 rounded-full border-2 border-indigo-100"></div>
                <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-violet-600 rounded-full flex items-center justify-center text-2xl shadow-lg text-white z-10 transition-transform duration-300" id="aiFace">
                    ü§ñ
                </div>
            </div>

            <h2 class="text-lg font-bold text-slate-800">AI Assistant</h2>
            <div class="h-1 w-10 bg-indigo-100 mx-auto rounded-full my-3"></div>
            
            <div id="aiFeedback" class="text-sm text-slate-500 italic min-h-[3rem] transition-colors duration-300">
            "I'm listening. Start describing the problem..."
            </div>
        </div>

        <div class="bg-slate-900 rounded-xl shadow-lg p-5 text-white relative overflow-hidden mt-6">
            <div class="absolute top-0 right-0 w-24 h-24 bg-white/5 rounded-full -mr-8 -mt-8"></div>
            
            <div class="flex justify-between items-end mb-2">
                <span class="text-slate-400 text-xs font-semibold uppercase tracking-wider">Understanding</span>
                <span id="scoreText" class="text-2xl font-bold text-indigo-400">0%</span>
            </div>
            
            <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden">
                <div id="understandingBar" class="h-full bg-gradient-to-r from-indigo-400 to-violet-400 w-0 transition-all duration-500 ease-out"></div>
            </div>
            
            <p class="text-xs text-slate-500 mt-3">
                Keep refining your input until the AI fully grasps the context.
            </p>
        </div>

    </div>

  </aside>

</main>

<script>
/* ================= INIT ================= */

fetch("components/header.html")
  .then(r => r.text())
  .then(h => {
    // Inject and fix theme colors in header
    document.getElementById("header").innerHTML = h.replace(/teal/g, "indigo");

    // Load Data
    loadData();

    // Check Guard
    if (!isSetupComplete()) {
        // Uncomment in production
        // window.location.href = "setup.html";
        // return;
    }

    // Set Header Progress (Step 1 -> Level 1)
    if(typeof setProgress === 'function') setProgress(1); // Assuming 1 corresponds to "Problem" in your progress logic
  });

/* ================= SETUP GUARD ================= */

function isSetupComplete() {
  // Ensure lfaData exists
  if(typeof lfaData === 'undefined') return false;
  const p = lfaData.program;
  return p && p.name && p.theme && p.level && p.geography;
}

/* ================= AI STATE ================= */

let ai = {
  understanding: 0,   // 0‚Äì100
  stage: 1            // 1=raw, 2=narrowing, 3=clear
};

/* ================= CORE AI FLOW ================= */



/* ================= UI UPDATES ================= */

function updateUI(title, sub, tips, feedback) {
  // Smoothly update text
  const qEl = document.getElementById("aiQuestion");
  const sEl = document.getElementById("aiSubtext");
  
  if(qEl.innerText !== title) {
      qEl.style.opacity = 0;
      setTimeout(() => { qEl.innerText = title; qEl.style.opacity = 1; }, 200);
  }
  
  sEl.innerText = sub;

  // TIPS REMOVED FROM HTML, so we skip tips update to avoid errors
  // If we kept the container, we would update it here.
  
  // Update Feedback
  const fbEl = document.getElementById("aiFeedback");
  if (fbEl) {
      fbEl.innerText = feedback;
      if(feedback.includes("‚úÖ")) {
          fbEl.classList.remove("text-slate-500", "italic");
          fbEl.classList.add("text-green-600", "font-semibold");
      } else {
          fbEl.classList.add("text-slate-500", "italic");
          fbEl.classList.remove("text-green-600", "font-semibold");
      }
  }
}

/* ================= PROGRESS VISUALS ================= */

function updateProgress(score) {
  // Update Right Panel Bar
  const bar = document.getElementById("understandingBar");
  const txt = document.getElementById("scoreText");
  
  bar.style.width = score + "%";
  txt.innerText = score + "%";
}

/* ================= BUTTON STATES ================= */

function unlockContinue() {
  const b = document.getElementById("continueBtn");
  b.disabled = false;
  b.classList.remove("bg-slate-200", "text-slate-400");
  b.classList.add("bg-indigo-600", "hover:bg-indigo-700", "text-white", "hover:shadow-indigo-500/30", "transform", "hover:-translate-y-1");
}

function lockContinue() {
  const b = document.getElementById("continueBtn");
  b.disabled = true;
  b.classList.add("bg-slate-200", "text-slate-400");
  b.classList.remove("bg-indigo-600", "hover:bg-indigo-700", "text-white", "hover:shadow-indigo-500/30", "transform", "hover:-translate-y-1");
}

/* ================= NAV ================= */

// Original function kept for backward compatibility if user manually reaches 100%
function saveAndNext() {
  alert("Please submit the problem and answer follow-up questions to continue.");
}

/* ================= NEW LOGIC: SUBMIT & PARSE ================= */

async function submitProblem() {
  const problemText = document.getElementById("problemInput").value.trim();
  const feedbackEl = document.getElementById("aiFeedback");
  const aiAvatar = document.getElementById("aiFace");

  // 1. Validation
  if (problemText.length < 10) {
    alert("Please enter a clear problem before submitting.");
    return;
  }

  // 2. Show Loading State
  feedbackEl.innerText = "ü§ñ Analyzing your problem and generating specific questions...";
  feedbackEl.classList.add("animate-pulse", "text-indigo-600");
  feedbackEl.classList.remove("text-red-500", "italic", "text-slate-500");
  if(aiAvatar) aiAvatar.innerText = "‚ö°"; // Processing face

  try {
    const API_URL = "https://shivam-99x-teacher-rag-backend.hf.space/generate-followup";
    
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ query: problemText })
    });

    if (!res.ok) throw new Error("Server error");

    const data = await res.json();

    // üö´ SPECIAL CASE: Input not related to School Education
const notRelatedMsg = "Your input is not Related to Education System";

// If backend sends this message
if (
  data?.message?.includes(notRelatedMsg) ||
  data?.follow_up_questions?.includes(notRelatedMsg)
) {
  // Show message ONLY in AI Assistant panel
  feedbackEl.classList.remove("animate-pulse", "text-indigo-600");
  feedbackEl.classList.add("text-red-500", "font-medium");
  feedbackEl.innerText = `‚ö†Ô∏è ${notRelatedMsg}`;

  // Reset AI face
  if (aiAvatar) aiAvatar.innerText = "ü§ñ";

  // ‚ùå STOP HERE ‚Äì do NOT show adaptive questions
  return;
}

    // 3. Success State
    feedbackEl.classList.remove("animate-pulse", "text-indigo-600");
    feedbackEl.classList.add("text-green-600", "font-medium");
    feedbackEl.innerText = "‚úÖ I've identified some gaps. Please answer the questions below to proceed.";
    if(aiAvatar) aiAvatar.innerText = "üìù"; // Writing face

    // 4. Parse and Render Questions
    const questions = parseQuestions(data.follow_up_questions);
    renderFollowUpQuestions(questions);

    // 5. Hide Initial Buttons to force new flow
    const initialBtns = document.getElementById("initialButtons");
    if(initialBtns) initialBtns.style.display = "none";
    const continueBtn = document.getElementById("continueBtn");
    if (continueBtn) continueBtn.remove();
    
    // Disable main input to prevent changing context while answering
    const mainInput = document.getElementById("problemInput");
    mainInput.disabled = true;
    mainInput.classList.add("bg-slate-100", "text-slate-500");

  } catch (err) {
    feedbackEl.classList.remove("animate-pulse");
    feedbackEl.classList.add("text-red-500");
    feedbackEl.innerText = "‚ùå Error: Could not reach the AI server. Please try again.";
    console.error(err);
  }
}

/* ================= HELPER: PARSE QUESTIONS ================= */

function parseQuestions(text) {
  // Split by numbers like "1.", "2." or newlines
  const rawSplit = text.split(/(?:^|\n)\d+\.\s+/);
  // Filter out empty strings and trim whitespace
  return rawSplit.filter(q => q && q.trim().length > 5).map(q => q.trim());
}

/* ================= HELPER: RENDER QUESTIONS ================= */

function renderFollowUpQuestions(questions) {
  const container = document.getElementById("followUpContainer");
  container.innerHTML = ""; // Clear previous
  container.classList.remove("hidden");
  
  // Header for the new section
  const header = document.createElement("h3");
  header.className = "text-lg font-bold text-indigo-900 mb-4 flex items-center gap-2";
  header.innerHTML = `<span>üîç</span> AI-Powered Adaptive Questions`;
  container.appendChild(header);

  questions.forEach((q, index) => {
    // Wrapper
    const wrapper = document.createElement("div");
    wrapper.className = "bg-indigo-50/50 p-5 rounded-xl border border-indigo-100 transition-all hover:shadow-md";
    
    // Label
    const label = document.createElement("label");
    label.className = "block text-sm font-semibold text-slate-700 mb-2";
    label.innerText = `${index + 1}. ${q}`;
    
    // Textarea
    const textarea = document.createElement("textarea");
    textarea.className = "follow-up-answer w-full p-3 bg-white border border-slate-200 rounded-lg text-slate-700 focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all text-sm";
    textarea.rows = 2;
    textarea.placeholder = "Your answer here...";
    textarea.dataset.question = q; // Store question in dataset for saving later
    
    // Validation Listener
    textarea.oninput = validateAnswers;

    wrapper.appendChild(label);
    wrapper.appendChild(textarea);
    container.appendChild(wrapper);
  });

  // --- BUTTON SECTION START ---
  const btnWrapper = document.createElement("div");
  btnWrapper.className = "pt-4 flex justify-end gap-4"; // gap-4 adds space between buttons
  
  // 1. Continue Button (Existing)
  const finishBtn = document.createElement("button");
  finishBtn.id = "finalContinueBtn";
  finishBtn.disabled = true;
  finishBtn.onclick = finalizeAndNext;
  finishBtn.className = "px-6 py-3 rounded-xl font-bold text-white shadow-lg flex items-center gap-2 bg-slate-300 cursor-not-allowed transition-all";
  finishBtn.innerHTML = `
    Continue to Level 2
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
    </svg>
  `;

  // 2. New AI Analysis Button
  const analysisBtn = document.createElement("button");
  analysisBtn.id = "analysisBtn";
  analysisBtn.disabled = true; // Initially disabled
  analysisBtn.onclick = getAIAnalysis;
  analysisBtn.className = "px-6 py-3 rounded-xl font-bold text-indigo-700 bg-indigo-100 border border-indigo-200 shadow-sm flex items-center gap-2 opacity-50 cursor-not-allowed transition-all";
  analysisBtn.innerHTML = `
    <span>‚ö°</span> Get AI Analysis
  `;

  btnWrapper.appendChild(finishBtn);
  btnWrapper.appendChild(analysisBtn);
  container.appendChild(btnWrapper);
  // --- BUTTON SECTION END ---

  // Container for Analysis Result (Hidden by default)
  const resultDiv = document.createElement("div");
  resultDiv.id = "analysisResult";
  resultDiv.className = "hidden mt-6 p-6 bg-white border border-indigo-100 rounded-xl shadow-lg animate-fade-in";
  container.appendChild(resultDiv);
  
  // Auto-scroll to questions
  container.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

/* ================= HELPER: VALIDATE ANSWERS ================= */

function validateAnswers() {
  const inputs = document.querySelectorAll(".follow-up-answer");
  const btn = document.getElementById("finalContinueBtn");
  const analyzeBtn = document.getElementById("analysisBtn"); // Select new button
  let allValid = true;

  inputs.forEach(input => {
    if (input.value.trim().length < 1) {
      allValid = false;
    }
  });

  if (allValid) {
    // Enable Continue Button
    btn.disabled = false;
    btn.classList.remove("bg-slate-300", "cursor-not-allowed");
    btn.classList.add("bg-indigo-600", "hover:bg-indigo-700", "transform", "hover:-translate-y-1", "hover:shadow-indigo-500/30");
    
    // Enable Analysis Button
    if (analyzeBtn) {
        analyzeBtn.disabled = false;
        analyzeBtn.classList.remove("opacity-50", "cursor-not-allowed");
        analyzeBtn.classList.add("hover:bg-indigo-200", "hover:-translate-y-1", "hover:shadow-md");
    }
  } else {
    // Disable Continue Button
    btn.disabled = true;
    btn.classList.add("bg-slate-300", "cursor-not-allowed");
    btn.classList.remove("bg-indigo-600", "hover:bg-indigo-700", "transform", "hover:-translate-y-1", "hover:shadow-indigo-500/30");
    
    // Disable Analysis Button
    if (analyzeBtn) {
        analyzeBtn.disabled = true;
        analyzeBtn.classList.add("opacity-50", "cursor-not-allowed");
        analyzeBtn.classList.remove("hover:bg-indigo-200", "hover:-translate-y-1", "hover:shadow-md");
    }
  }
}

/* ================= FINAL SAVE & REDIRECT ================= */


async function finalizeAndNext() {
  const submitBtn = document.getElementById("finalContinueBtn"); // Ensure your button has this ID

  // 1Ô∏è‚É£ Get Section 1: Core problem
  const problemText = document.getElementById("problemInput").value.trim();

  // 2Ô∏è‚É£ Get Section 2: Dynamic follow-up answers
  const inputs = document.querySelectorAll(".follow-up-answer");
  const answersData = Array.from(inputs).map(input => ({
    question: input.dataset.question,
    answer: input.value.trim()
  }));

  // 3Ô∏è‚É£ Construct the Payload for Backend
  const payload = {
    userId: "user_123", // Optional: Replace with real ID if you have one
    problem: problemText,
    followUpAnswers: answersData,
    timestamp: new Date().toISOString()
  };

  // ---------------------------------------------------------
  // üöÄ NEW STEP: Send to Python Backend
  // ---------------------------------------------------------
  try {
    // A. Show Loading State
    if (submitBtn) {
        submitBtn.innerText = "Syncing with Server...";
        submitBtn.disabled = true;
    }

    // B. Send Data
    // Replace 'YOUR_BACKEND_URL' with your actual Python endpoint (e.g., http://localhost:8000/submit-level1)
    const response = await fetch("https://shivam-99x-level1-undestandingscore.hf.space/submit-level1", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      throw new Error(`Server error: ${response.status}`);
    }

    const serverResponse = await response.json();
    console.log("Backend sync successful:", serverResponse);

    // Optional: If the backend returns new data for Level 2, save it here
    // localStorage.setItem("level2_init_data", JSON.stringify(serverResponse));

  } catch (error) {
    console.error("Failed to sync with backend:", error);
    // Decision: Do you want to stop the user if backend fails?
    // If NO, just alert and let them proceed. If YES, return here.
    alert("Note: Data could not be synced to the server, but proceeding locally.");
  }

  // ---------------------------------------------------------
  // üíæ EXISTING LOGIC: Save Locally & Redirect
  // ---------------------------------------------------------
  
  // Part A: Update app variable
  if (typeof lfaData !== "undefined") {
    lfaData.problem = problemText;
    lfaData.followUpAnswers = answersData;
    if (typeof saveData === "function") saveData();
  }

  // Part B: LocalStorage for Level 2 & Level 7
  localStorage.setItem("level1_data", JSON.stringify(payload));

  // 4Ô∏è‚É£ Move to Level 2
  window.location.href = "level2.html";
}



function goBack() {
  window.location.href = "setup.html";
}
async function getAIAnalysis() {
  const btn = document.getElementById("analysisBtn");
  const resultDiv = document.getElementById("analysisResult");
  
  // 1. UI Loading State
  const originalText = btn.innerHTML;
  btn.innerHTML = `<span>‚è≥</span> Analyzing...`;
  btn.disabled = true;
  resultDiv.classList.add("hidden"); 
  
  // 2. Gather Data
  const problemText = document.getElementById("problemInput").value.trim();
  const inputs = document.querySelectorAll(".follow-up-answer");
  const answersData = Array.from(inputs).map(input => ({
    question: input.dataset.question,
    answer: input.value.trim()
  }));

  const payload = {
    userId: "user_test",
    problem: problemText,
    followUpAnswers: answersData,
    timestamp: new Date().toISOString()
  };

  try {
    // 3. Send to your Hugging Face Backend
    const API_URL = "https://shivam-99x-level1-undestandingscore.hf.space/submit-level1";
    
    const response = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!response.ok) throw new Error("Server Error");

    const data = await response.json();
    
    // ============================================================
    // üéØ LOGIC: Extract Score & Update Visuals
    // ============================================================
    
    // Regex to find "Understanding Score: 0%" at the end
    const scoreMatch = data.analysis.match(/Understanding Score:\s*(\d+)%/i);
    
    let finalScore = 0;
    if (scoreMatch && scoreMatch[1]) {
        finalScore = parseInt(scoreMatch[1], 10);
    }

    // Update the Visuals (Bar & Text)
    const bar = document.getElementById("understandingBar");
    const txt = document.getElementById("scoreText");
    
    // Update text and width
    txt.innerText = finalScore + "%";
    bar.style.width = finalScore + "%";

    // Color coding based on score
    // Note: We use setTimeout to ensure the transition animation plays nicely
    setTimeout(() => {
        if (finalScore >= 80) {
            txt.className = "text-2xl font-bold text-green-400";
            bar.className = "h-full bg-green-500 w-0 transition-all duration-500 ease-out";
        } else if (finalScore >= 40) {
            txt.className = "text-2xl font-bold text-yellow-400";
            bar.className = "h-full bg-yellow-400 w-0 transition-all duration-500 ease-out";
        } else {
            txt.className = "text-2xl font-bold text-indigo-400"; // Default/Low
            bar.className = "h-full bg-gradient-to-r from-indigo-400 to-violet-400 w-0 transition-all duration-500 ease-out";
        }
        // Re-apply width after class change to trigger animation
        bar.style.width = finalScore + "%";
    }, 50);

    // ============================================================

    // 4. Display Result (Showing full text including score)
    resultDiv.classList.remove("hidden");
    resultDiv.innerHTML = `
        <div class="flex items-start gap-4">
            <div class="p-3 bg-indigo-50 rounded-lg text-2xl">ü§ñ</div>
            <div class="w-full">
                <h4 class="font-bold text-indigo-900 text-lg mb-2">AI Analysis</h4>
                <div class="text-slate-700 text-sm leading-relaxed whitespace-pre-wrap">${data.analysis}</div>
            </div>
        </div>
    `;
    
    // Scroll to result
    resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

  } catch (err) {
    alert("Could not connect to the analysis server. Please try again.");
    console.error(err);
  } finally {
    // Reset Button
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
}
</script>

</body>
</html>
