<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Level 7 ‚Äì Indicators | ShikshaManthan</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script src="assets/js/data.js"></script>
  <script src="assets/js/progress.js"></script>

  <style>
    body { font-family: 'Poppins', sans-serif; }

    /* Background Pattern */
    .bg-grid-pattern {
        background-image: radial-gradient(#6366f1 0.5px, transparent 0.5px);
        background-size: 24px 24px;
        opacity: 0.1;
    }

    /* AI Animations */
    @keyframes pulse-ring {
        0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
        100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
    }
    .ai-thinking { animation: pulse-ring 2s infinite; }

    /* Thinking Dots */
    .thinking-dots span {
        animation: bounce 1.4s infinite ease-in-out both;
        background-color: #6366f1;
        border-radius: 50%;
        display: inline-block;
        height: 6px;
        width: 6px;
        margin: 0 2px;
    }
    .thinking-dots span:nth-child(1) { animation-delay: -0.32s; }
    .thinking-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }

    /* Layout Transitions */
    #mainGrid {
        transition: grid-template-columns 0.8s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    /* Markdown Styles (Critical for AI Output) */
    .ai-markdown h3 { 
        font-weight: 700; 
        color: #1e293b; 
        margin-top: 12px; 
        margin-bottom: 6px; 
        font-size: 0.95rem;
        border-bottom: 1px solid #e2e8f0; 
        padding-bottom: 4px;
    }
    .ai-markdown strong { 
        color: #4f46e5; 
        font-weight: 700; 
    }
    .ai-markdown ul { 
        list-style-type: disc; 
        padding-left: 1.2rem; 
        margin-bottom: 0.5rem; 
        margin-top: 0.5rem;
    }
    .ai-markdown li { 
        margin-bottom: 4px; 
        color: #334105;
    }
    .ai-markdown p {
        margin-bottom: 8px;
    }

    /* Animation for New Cards */
    @keyframes slide-down {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-slide-down { animation: slide-down 0.3s ease-out forwards; }
    
    #progressBar, .progress-bar-fill { background-color: #4f46e5 !important; }
  </style>
</head>

<body class="bg-slate-50 min-h-screen relative text-slate-800 overflow-x-hidden">

<div class="fixed inset-0 bg-grid-pattern pointer-events-none z-0"></div>

<div id="header" class="relative z-20 sticky top-0 bg-white/90 backdrop-blur shadow-sm"></div>

<main id="mainGrid" class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 mb-20 grid grid-cols-1 lg:grid-cols-[2fr_1fr] gap-8">

  <section id="leftPanel" class="bg-white rounded-2xl shadow-xl border border-slate-100 p-6 sm:p-8 relative overflow-hidden flex flex-col h-full transition-all duration-500">
    
    <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-indigo-500 via-violet-500 to-indigo-500"></div>

    <div class="mb-8">
      <div class="flex items-center gap-3 mb-2">
        <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-bold uppercase tracking-wide">Level 7 ‚Ä¢ Final Step</span>
      </div>
      <h1 class="text-2xl sm:text-3xl font-bold text-slate-800 leading-tight">
        What evidence will show that your actions & stakeholder efforts have addressed the problem?
      </h1>
      <p class="text-slate-500 mt-2 text-sm sm:text-base">
        Define <strong>indicators</strong> (evidence) that show whether the Student Outcome is actually happening.
      </p>
    </div>

    <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-5 mb-8">
        <h3 class="text-indigo-900 font-semibold text-sm mb-3 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Requirements:
        </h3>
        <ul class="space-y-2 text-sm text-slate-700">
          <li class="flex items-start gap-3">
            <span class="mt-1.5 w-1.5 h-1.5 bg-indigo-500 rounded-full flex-shrink-0"></span>
            <span><strong>Minimum 10 words</strong> per indicator to ensure detail.</span>
          </li>
          <li class="flex items-start gap-3">
            <span class="mt-1.5 w-1.5 h-1.5 bg-indigo-500 rounded-full flex-shrink-0"></span>
            <span>Focus on <strong>change</strong>, not just activity counts.</span>
          </li>
        </ul>
    </div>

    <div id="indicatorContainer" class="space-y-6">
        </div>

    <button onclick="addIndicator()"
      class="mt-6 w-full py-4 border-2 border-dashed border-indigo-200 rounded-xl text-indigo-500 font-medium hover:bg-indigo-50 hover:border-indigo-400 transition-all flex items-center justify-center gap-2 group">
      <span class="text-xl group-hover:scale-110 transition-transform">+</span> Add another indicator
    </button>

    <div class="mt-10 flex items-center justify-between border-t border-slate-100 pt-6">
      <button onclick="goBack()"
        class="flex items-center gap-2 px-5 py-2.5 rounded-full text-slate-500 hover:bg-slate-100 hover:text-slate-700 font-medium transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        Back
      </button>

      <button id="continueBtn"
        disabled
        onclick="saveAndNext()"
        class="px-8 py-3 rounded-xl font-bold text-white shadow-lg transition-all transform active:scale-95 flex items-center gap-2 disabled:bg-slate-200 disabled:text-slate-400 disabled:shadow-none disabled:cursor-not-allowed bg-indigo-600 hover:bg-indigo-700 hover:shadow-indigo-500/30">
        Finish & Review üéâ
      </button>
    </div>

  </section>

  <aside id="rightPanel" class="space-y-6 transition-all duration-500">
    
    <div class="bg-white rounded-2xl shadow-lg border border-indigo-100 overflow-hidden flex flex-col h-auto min-h-[350px]">
        
        <div class="bg-gradient-to-r from-indigo-50 to-white px-5 py-3 border-b border-indigo-50 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div id="aiAvatarContainer" class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-lg shadow-sm border border-indigo-200 relative">
                    <span id="aiFace">ü§ñ</span>
                    <div id="aiPulse" class="absolute inset-0 rounded-full border border-indigo-300 opacity-0"></div>
                </div>
                <div>
                    <h2 class="text-sm font-bold text-slate-800">Measurement Expert</h2>
                    <p class="text-[10px] text-slate-500 uppercase tracking-wider font-medium">Real-time Analysis</p>
                </div>
            </div>
            <div id="statusLight" class="w-2 h-2 rounded-full bg-slate-300"></div>
        </div>

        <div class="p-5 flex-1 bg-slate-50/50 relative flex flex-col">
            
            <div id="thinkingIndicator" class="hidden items-center gap-2 text-xs text-indigo-500 font-medium mb-3">
                <span>Analyzing indicators</span>
                <div class="thinking-dots"><span></span><span></span><span></span></div>
            </div>

            <div class="bg-white p-4 rounded-xl rounded-tl-none border border-slate-200 shadow-sm text-sm text-slate-600 leading-relaxed relative flex-grow">
                <div id="aiFeedback" class="min-h-[40px] ai-markdown">
                    I'm listening. Define indicators that measure <strong>change</strong>, not just activity.
                </div>
                <div class="absolute top-0 -left-2 w-3 h-3 bg-white border-l border-t border-slate-200 transform -rotate-45"></div>
            </div>

        </div>
    </div>

    <div class="bg-slate-900 rounded-2xl shadow-lg p-6 text-white relative overflow-hidden">
        <h3 class="font-semibold text-indigo-300 mb-4 flex items-center gap-2">
            <span>üìè</span> The Gold Standard
        </h3>
        
        <ul class="space-y-3 text-sm text-slate-300">
            <li class="flex gap-2">
                <span class="text-green-400">‚úì</span> Minimum 10 words per item
            </li>
            <li class="flex gap-2">
                <span class="text-green-400">‚úì</span> Show evidence of practice change
            </li>
            <li class="flex gap-2">
                <span class="text-green-400">‚úì</span> Evidence must be observable or measurable
            </li>
        </ul>

        <div class="mt-4 pt-4 border-t border-slate-700">
             <p class="text-xs font-bold text-red-400 uppercase tracking-widest mb-2">Avoid</p>
             <p class="text-xs text-slate-400">
                Don't just count "Number of trainings" or "Number of meetings".
             </p>
        </div>
    </div>

  </aside>

</main>

<script>
/* ================= INIT ================= */
const MEASUREMENT_BACKEND_URL =
  "https://shivam-99x-shikshamanthan-stakeholder-backend.hf.space/evaluate-measurement";

fetch("components/header.html")
  .then(r => r.text())
  .then(h => {
    document.getElementById("header").innerHTML = h.replace(/teal/g, "indigo");
    loadData();
    if(typeof setProgress === 'function') setProgress(84);
    lfaData.indicators = lfaData.indicators || [];
    renderIndicators();
  });

/* ================= RENDER ================= */

function renderIndicators() {
  const container = document.getElementById("indicatorContainer");
  container.innerHTML = "";

  if (lfaData.indicators.length === 0) {
    addIndicator();
    return;
  }

  lfaData.indicators.forEach((ind, idx) => {
    container.appendChild(createIndicatorBox(ind, idx));
  });
  
  evaluateState();
}

function createIndicatorBox(indicator, index) {
  const box = document.createElement("div");
  box.className = "animate-slide-down border border-slate-200 rounded-xl p-5 bg-white shadow-sm hover:border-indigo-300 transition-all relative group";

  const deleteBtn = lfaData.indicators.length > 1 ? `
    <button onclick="removeIndicator(${index})" class="absolute top-4 right-4 text-slate-400 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100 z-10">
        üóëÔ∏è
    </button>` : '';

  const outcomeText = lfaData.studentOutcome || "Student Outcome (Defined in Level 2)";
  const truncatedOutcome = outcomeText.length > 50 ? outcomeText.substring(0, 50) + "..." : outcomeText;

  const wordCount = indicator.text ? indicator.text.trim().split(/\s+/).filter(w => w.length > 0).length : 0;
  const wordColor = wordCount >= 10 ? "text-green-600" : "text-slate-400";

  box.innerHTML = `
    ${deleteBtn}
    <div class="flex flex-col gap-3">
        <div class="flex items-center gap-2 text-xs font-bold text-indigo-500 uppercase tracking-wide mb-1">
             <span class="w-2 h-2 rounded-full bg-indigo-500"></span>
             Measuring Evidence For:
        </div>
        <div class="p-3 bg-indigo-50 border border-indigo-100 rounded-lg text-sm text-indigo-900 flex items-start gap-2">
            <span class="text-lg">üéØ</span>
            <span class="italic opacity-80">${truncatedOutcome}</span>
        </div>
        <div class="relative mt-2">
            <textarea
            rows="4"
            placeholder="e.g. 70% of students answer comprehension questions correctly... (min 10 words)"
            class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 placeholder-slate-400 focus:bg-white focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 resize-none transition-all"
            oninput="updateIndicator(${index}, 'text', this.value)"
            id="input-${index}"
            >${indicator.text || ""}</textarea>
            <div class="flex justify-between items-center mt-2 px-1">
                <span id="wordcount-${index}" class="text-xs font-medium ${wordColor}">${wordCount}/10 words</span>
                <span id="status-${index}" class="text-lg transition-opacity opacity-0"></span>
            </div>
        </div>
    </div>
  `;
  return box;
}

/* ================= ACTIONS ================= */

function addIndicator() {
  lfaData.indicators.push({ outcome: lfaData.studentOutcome, text: "" });
  renderIndicators();
}

function removeIndicator(index) {
    lfaData.indicators.splice(index, 1);
    renderIndicators();
    if(lfaData.indicators.length === 0) resetLayout();
}

function updateIndicator(index, field, value) {
  lfaData.indicators[index][field] = value.trim();
  
  const words = value.trim().split(/\s+/).filter(w => w.length > 0);
  const count = words.length;
  const counterEl = document.getElementById(`wordcount-${index}`);
  const statusEl = document.getElementById(`status-${index}`);
  
  counterEl.innerText = `${count}/10 words`;

  const activityWords = ["number of", "count", "sessions", "trainings", "meetings", "workshops"];
  
  if (value.length === 0) {
      statusEl.style.opacity = '0';
      counterEl.className = "text-xs font-medium text-slate-400";
  } else if (count < 10) {
      statusEl.innerHTML = '‚ö†Ô∏è';
      statusEl.className = "text-lg text-yellow-500 transition-opacity opacity-100";
      counterEl.className = "text-xs font-medium text-yellow-600";
  } else if (activityWords.some(w => value.toLowerCase().includes(w))) {
      statusEl.innerHTML = 'üõë';
      statusEl.className = "text-lg text-red-500 transition-opacity opacity-100";
      counterEl.className = "text-xs font-medium text-red-600";
  } else {
      statusEl.innerHTML = '‚úÖ';
      statusEl.className = "text-lg text-green-500 transition-opacity opacity-100";
      counterEl.className = "text-xs font-medium text-green-600";
  }
  evaluateState();
}

/* ================= STATE EVALUATION ================= */

function evaluateState() {
  const activityWords = ["number of", "count", "sessions", "trainings", "meetings", "workshops"];
  let allPass = true;
  let errorMsg = "";
  let emoji = "";

  if (lfaData.indicators.length === 0) allPass = false;

  for (const ind of lfaData.indicators) {
    const text = ind.text || "";
    const words = text.trim().split(/\s+/).filter(w => w.length > 0);
    
    if (words.length < 10) {
      allPass = false;
      errorMsg = "‚ö†Ô∏è Keep writing! Indicators need to be at least 10 words.";
      emoji = "üßê";
    }
    else if (activityWords.some(w => text.toLowerCase().includes(w))) {
      allPass = false;
      errorMsg = "üõë Avoid counting activities. Focus on the result.";
      emoji = "üôÖ‚Äç‚ôÇÔ∏è";
    }
  }

  const statusLight = document.getElementById("statusLight");

  if (!allPass) {
    if(!errorMsg) errorMsg = "Add at least one detailed indicator.";
    updateFeedback(errorMsg, "text-yellow-600");
    updateVisuals(emoji || "ü§î", false);
    statusLight.classList.remove("bg-green-500", "animate-pulse");
    statusLight.classList.add("bg-yellow-400");
    lockContinue();
    resetLayout();
  } else {
    statusLight.classList.remove("bg-yellow-400");
    statusLight.classList.add("bg-green-500", "animate-pulse");
    shiftLayoutForFocus();
    updateVisuals("üéâ", false);
    unlockContinue();
    evaluateMeasurementWithLLM(); 
  }
}

/* ================= LAYOUT & UI HELPERS ================= */

function shiftLayoutForFocus() {
    if(window.innerWidth >= 1024) {
        const grid = document.getElementById("mainGrid");
        grid.classList.remove("lg:grid-cols-[2fr_1fr]");
        grid.style.gridTemplateColumns = "1fr 1fr"; 
    }
}

function resetLayout() {
    if(window.innerWidth >= 1024) {
        const grid = document.getElementById("mainGrid");
        grid.style.gridTemplateColumns = ""; 
        grid.classList.add("lg:grid-cols-[2fr_1fr]");
    }
}

function updateVisuals(emoji, isThinking) {
    document.getElementById("aiFace").innerText = emoji;
    const pulse = document.getElementById("aiPulse");
    if(isThinking) {
        pulse.classList.add("ai-thinking", "opacity-100");
    } else {
        pulse.classList.remove("ai-thinking", "opacity-100");
    }
}

function updateFeedback(msg, colorClass) {
    const fb = document.getElementById("aiFeedback");
    fb.className = `min-h-[40px] ai-markdown ${colorClass}`;
    fb.innerHTML = parseMarkdown(msg);
}

function showThinking(show) {
    const indicator = document.getElementById("thinkingIndicator");
    if(show) {
        indicator.classList.remove("hidden");
        indicator.classList.add("flex");
        document.getElementById("aiFeedback").innerHTML = "";
    } else {
        indicator.classList.add("hidden");
        indicator.classList.remove("flex");
    }
}

function parseMarkdown(text) {
    if(!text) return "";
    let html = text.replace(/### (.*?)(\n|$)/g, '<h3>$1</h3>');
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
    html = html.replace(/^\- (.*?)(\n|$)/gm, '<li>$1</li>');
    html = html.replace(/\n/g, '<br>');
    return html;
}

/* ================= AI LOGIC & STORAGE ================= */

async function evaluateMeasurementWithLLM() {
  if(document.getElementById("statusLight").classList.contains("processing")) return;
  document.getElementById("statusLight").classList.add("processing");

  const indicators = lfaData.indicators.map(i => i.text).filter(t => t.length > 0);
  
  showThinking(true);
  updateVisuals("ü§ñ", true);

  try {
    const res = await fetch(MEASUREMENT_BACKEND_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        student_outcome: lfaData.studentOutcome,
        indicators: indicators
      })
    });

    const data = await res.json();

    showThinking(false);
    updateVisuals("ü§ì", false); 
    updateFeedback(data.response, "text-slate-700");

    // --- STRATEGIC STORAGE ---
    // We save the full AI critique and specifically flag completion
    lfaData.measurementResults = {
        critique: data.response,
        timestamp: new Date().toISOString(),
        isValidated: true
    };
    
    // Also save the simple key for backward compatibility
    lfaData.measurementCheck = data.response;
    
    saveData(); // Commit to LocalStorage

  } catch (err) {
    showThinking(false);
    updateVisuals("üòµ", false);
    updateFeedback("‚ùå Connection error. Please try again.", "text-red-500");
    console.error(err);
  } finally {
      document.getElementById("statusLight").classList.remove("processing");
  }
}

/* ================= NAV ================= */

function unlockContinue() {
  const b = document.getElementById("continueBtn");
  b.disabled = false;
  b.classList.remove("bg-slate-200", "text-slate-400", "disabled:cursor-not-allowed");
  b.classList.add("bg-indigo-600", "hover:bg-indigo-700", "text-white", "shadow-lg");
}

function lockContinue() {
  const b = document.getElementById("continueBtn");
  b.disabled = true;
  b.classList.add("bg-slate-200", "text-slate-400", "disabled:cursor-not-allowed");
  b.classList.remove("bg-indigo-600", "hover:bg-indigo-700", "text-white", "shadow-lg");
}

function saveAndNext() {
  saveData();
  window.location.href = "review.html";
}

function goBack() {
  window.location.href = "level6.html";
}
</script>

</body>
</html>
